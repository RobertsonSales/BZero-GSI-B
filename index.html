<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OP BZERO - An√°lise de Opera√ß√µes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    :root { 
      --primary: #1e40af; 
      --success: #059669; 
      --gray: #f8fafc; 
      --danger: #dc2626; 
      --warning: #f59e0b;
      --purple: #8b5cf6;
      --cyan: #06b6d4;
    }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); 
      margin:0; 
      padding:20px; 
      color:#1e293b; 
      min-height: 100vh;
    }
    .container { 
      max-width:1600px; 
      margin:auto; 
      background:white; 
      border-radius:24px; 
      box-shadow:0 20px 60px rgba(0,0,0,0.15); 
      overflow:hidden; 
      position: relative;
    }
    header { 
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); 
      color:white; 
      padding:40px 30px; 
      text-align:center; 
      position: relative;
      overflow: hidden;
    }
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%233b82f6' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
      opacity: 0.3;
    }
    header h1 { 
      margin:0; 
      font-size:2.8rem; 
      font-weight:800; 
      letter-spacing: -0.5px;
      position: relative;
    }
    header p { 
      margin-top:15px; 
      opacity:0.95; 
      font-size:1.2rem;
      position: relative;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    .upload-area { 
      padding:100px 30px; 
      text-align:center; 
      border:3px dashed #94a3b8; 
      border-radius:24px; 
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      margin:40px; 
      cursor:pointer; 
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .upload-area::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent 30%, rgba(59, 130, 246, 0.1) 50%, transparent 70%);
      transition: transform 0.8s;
      transform: translateX(-100%);
    }
    .upload-area:hover::before {
      transform: translateX(100%);
    }
    .upload-area:hover { 
      border-color:var(--primary); 
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      transform: translateY(-8px) scale(1.01);
      box-shadow: 0 20px 40px rgba(30, 64, 175, 0.2);
    }
    .upload-area i { 
      font-size:80px; 
      color:#64748b; 
      margin-bottom:25px;
      position: relative;
    }
    .upload-area h3 {
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: #1e293b;
    }
    .upload-area p {
      color: #64748b;
      font-size: 1.1rem;
    }

    .controls { 
      padding:30px; 
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-bottom:1px solid #e2e8f0; 
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }
    .filter-row { 
      display:grid; 
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); 
      gap:20px; 
      align-items:end; 
    }
    .filter-group { 
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .filter-group label { 
      font-weight:600; 
      margin-bottom:10px; 
      display:block; 
      color: #1e293b;
      font-size: 0.95rem;
    }
    select { 
      padding:14px 18px; 
      border:2px solid #e2e8f0; 
      border-radius:12px; 
      background:white; 
      font-size:15px; 
      width:100%; 
      transition: all 0.3s;
      color: #334155;
    }
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }
    .buttons { 
      display:flex; 
      gap:15px; 
      flex-wrap:wrap; 
      margin-top:20px;
      justify-content: flex-end;
    }
    button { 
      padding:15px 28px; 
      border:none; 
      border-radius:12px; 
      font-weight:600; 
      cursor:pointer; 
      display:flex; 
      align-items:center; 
      gap:12px; 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 16px;
      letter-spacing: 0.3px;
      position: relative;
      overflow: hidden;
    }
    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    button:hover::before {
      width: 300px;
      height: 300px;
    }
    .btn-primary { 
      background: linear-gradient(135deg, var(--primary) 0%, #1e3a8a 100%); 
      color:white;
      box-shadow: 0 6px 20px rgba(30, 64, 175, 0.3);
    }
    .btn-primary:hover { 
      background: linear-gradient(135deg, #1e3a8a 0%, #1e3a8a 100%);
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(30, 64, 175, 0.4);
    }
    .btn-success { 
      background: linear-gradient(135deg, var(--success) 0%, #047857 100%); 
      color:white;
      box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3);
    }
    .btn-success:hover { 
      background: linear-gradient(135deg, #047857 0%, #065f46 100%);
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(5, 150, 105, 0.4);
    }
    .btn-excel { 
      background: linear-gradient(135deg, #217346 0%, #185c37 100%); 
      color:white; 
      box-shadow: 0 6px 20px rgba(33, 115, 70, 0.3);
    }
    .btn-excel:hover { 
      background: linear-gradient(135deg, #185c37 0%, #134e2c 100%);
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(33, 115, 70, 0.4);
    }

    /* NOVO DASHBOARD COM CARDS ATRAVES */
    .dashboard { 
      display:grid; 
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); 
      gap:30px; 
      padding:40px 30px;
    }
    .dashboard-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(226, 232, 240, 0.6);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .dashboard-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, var(--card-color), var(--card-color-dark));
    }
    .dashboard-card:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    .card-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 25px;
    }
    .card-icon {
      width: 70px;
      height: 70px;
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: white;
      background: linear-gradient(135deg, var(--card-color), var(--card-color-dark));
      flex-shrink: 0;
      box-shadow: 0 8px 20px rgba(var(--card-rgb), 0.3);
    }
    .card-title {
      margin: 0;
      color: #1e293b;
      font-size: 1.4rem;
      font-weight: 700;
    }
    .card-subtitle {
      margin: 5px 0 0;
      color: #64748b;
      font-size: 0.95rem;
    }
    .card-value {
      font-size: 3.5rem;
      font-weight: 900;
      color: var(--card-color-dark);
      margin: 15px 0;
      line-height: 1;
      text-align: center;
      background: linear-gradient(135deg, var(--card-color), var(--card-color-dark));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .card-trend {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: #059669;
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid #e2e8f0;
    }
    .card-action {
      margin-top: 20px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: var(--card-color);
      font-weight: 600;
      transition: all 0.3s;
    }
    .card-action:hover {
      background: var(--card-color);
      color: white;
      transform: translateX(5px);
    }

    .modal, .modalPerf, .modalDetalhes { 
      display:none; 
      position:fixed; 
      inset:0; 
      background:rgba(0,0,0,0.75); 
      justify-content:center; 
      align-items:center; 
      z-index:2000; 
      padding:20px; 
      backdrop-filter: blur(5px);
    }
    .modal-content, .modalPerf-content, .modalDetalhes-content { 
      background:white; 
      width:95%; 
      max-width:1500px; 
      max-height:95vh; 
      border-radius:24px; 
      overflow:hidden; 
      box-shadow:0 30px 80px rgba(0,0,0,0.4);
      animation: modalAppear 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    @keyframes modalAppear {
      from {
        opacity: 0;
        transform: translateY(50px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    .modal-header { 
      background: linear-gradient(135deg, var(--primary) 0%, #1e3a8a 100%);
      color:white; 
      padding:25px 35px; 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      font-size:1.6rem; 
      font-weight:600;
    }
    .modal-actions { 
      display: flex; 
      gap: 12px; 
      align-items: center;
    }
    .close { 
      font-size:40px; 
      cursor:pointer; 
      font-weight:300;
      margin-left: 20px;
      transition: transform 0.3s;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    .close:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: rotate(90deg);
    }
    .modal-body { 
      padding:35px; 
      overflow-y:auto; 
      max-height:calc(95vh - 120px); 
    }

    .charts-container { 
      display:grid; 
      grid-template-columns:repeat(auto-fit,minmax(450px,1fr)); 
      gap:30px; 
      margin:30px 0; 
    }
    .chart-card { 
      background:white; 
      padding:25px; 
      border-radius:18px; 
      box-shadow:0 8px 25px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
    }

    .depto-resumo { 
      display:grid; 
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); 
      gap:25px; 
      margin:40px 0; 
    }
    .depto-card { 
      background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-left:6px solid var(--primary); 
      padding:25px; 
      border-radius:16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.05);
    }
    .depto-card h4 { 
      margin:0 0 20px; 
      color:var(--primary); 
      font-size:1.4rem; 
      font-weight: 700;
    }
    .depto-card .stats { 
      display:grid; 
      grid-template-columns:1fr 1fr; 
      gap:15px; 
      font-size:15px; 
    }
    .depto-card .stats div {
      background: white;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
    }
    .depto-card .stats strong { 
      color:#1e3a8a; 
      font-size: 1.3rem;
      display: block;
      margin-bottom: 5px;
    }

    .registros-depto { 
      margin-top:50px; 
      border-top:2px solid #e2e8f0; 
      padding-top:30px; 
    }
    .registros-depto h4 { 
      color:var(--primary); 
      margin-bottom:20px; 
      font-size: 1.5rem;
    }
    table { 
      width:100%; 
      border-collapse:separate; 
      border-spacing:0;
      margin-top:20px; 
      font-size:14px; 
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    th { 
      background: linear-gradient(135deg, var(--primary) 0%, #1e3a8a 100%);
      color:white; 
      padding:18px 15px; 
      text-align:center;
      font-weight: 600;
      border-right: 1px solid rgba(255,255,255,0.1);
    }
    th:last-child {
      border-right: none;
    }
    td { 
      padding:16px 15px; 
      text-align:center; 
      border-bottom:1px solid #e2e8f0;
      background: white;
    }
    tr:hover td { 
      background:#f0f9ff; 
    }
    tr:last-child td {
      border-bottom: none;
    }

    .hidden { 
      display:none !important; 
    }
    .status { 
      text-align:center; 
      padding:20px; 
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color:#065f46; 
      font-weight:600; 
      border-radius:16px; 
      margin:30px; 
      font-size: 1.1rem;
      box-shadow: 0 6px 20px rgba(5, 150, 105, 0.15);
    }
    .error-status { 
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important; 
      color:#991b1b !important; 
      box-shadow: 0 6px 20px rgba(220, 38, 38, 0.15);
    }

    /* Estilos para o modal de detalhes */
    .detalhes-lista {
      display: grid;
      gap: 15px;
      margin: 25px 0;
    }
    .detalhe-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: #f8fafc;
      border-radius: 12px;
      transition: all 0.3s;
    }
    .detalhe-item:hover {
      background: #f1f5f9;
      transform: translateX(5px);
    }
    .detalhe-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .detalhe-valor {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--primary);
    }
    .detalhe-local {
      color: #64748b;
      font-size: 0.95rem;
    }
    .detalhe-data {
      color: #94a3b8;
      font-size: 0.9rem;
    }

    /* Estilos para o rodap√© */
    .footer {
      text-align: center;
      padding: 30px;
      color: #64748b;
      font-size: 0.9rem;
      border-top: 1px solid #e2e8f0;
      background: #f8fafc;
    }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>OPERA√á√ÉO BARRICADA ZERO ‚Äì Dashboard Apreens√µes</h1>
    <p>An√°lise avan√ßada de opera√ß√µes realizadas em parceria com a PMERJ</p>
  </header>

  <div id="uploadSection" class="upload-area">
    <i class="fas fa-cloud-upload-alt"></i>
    <h3>Clique para importar o arquivo Excel</h3>
    <p><strong>OP BZERO.xlsx</strong> (Formatos suportados: .xlsx, .xls)</p>
    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none">
  </div>

  <div id="status" class="status hidden"></div>

  <div id="mainControls" class="hidden">
    <div class="controls">
      <div class="filter-row">
        <div class="filter-group">
          <label><i class="fas fa-building"></i> Departamento</label>
          <select id="filterDepto"><option value="">Todos os Departamentos</option></select>
        </div>
        <div class="filter-group">
          <label><i class="fas fa-shield-alt"></i> Unidade (DP)</label>
          <select id="filterUnid"><option value="">Todas as Unidades</option></select>
        </div>
        <div class="filter-group">
          <label><i class="fas fa-map-marker-alt"></i> Local / Comunidade</label>
          <select id="filterLocal"><option value="">Todos os Locais</option></select>
        </div>
        <div class="filter-group">
          <label><i class="fas fa-users"></i> Fac√ß√£o</label>
          <select id="filterFaccao"><option value="">Todas as Fac√ß√µes</option></select>
        </div>
      </div>
      <div class="buttons">
        <button id="btnAnalise" class="btn-primary">
          <i class="fas fa-chart-line"></i> An√°lise de Performance
        </button>
        <button id="btnPdf" class="btn-success">
          <i class="fas fa-file-pdf"></i> Gerar PDF Completo
        </button>
      </div>
    </div>

    <div class="dashboard" id="dashboard"></div>
  </div>

  <div class="footer">
    <p>OP BZERO - Sistema de Intelig√™ncia Operacional | Desenvolvido para an√°lise estrat√©gica de opera√ß√µes</p>
    <p>¬© GSI - 2025 Todos os direitos reservados</p>
  </div>
</div>

<!-- Modal Performance -->
<div id="modalPerf" class="modalPerf">
  <div class="modalPerf-content">
    <div class="modal-header">
      <div><i class="fas fa-chart-bar"></i> An√°lise de Performance por Departamento</div>
      <div class="modal-actions">
        <button id="btnExportarExcel" class="btn-excel">
          <i class="fas fa-file-excel"></i> Exportar Excel
        </button>
        <button id="btnPdfPerf" class="btn-success">
          <i class="fas fa-file-pdf"></i> Gerar PDF
        </button>
        <span class="close">√ó</span>
      </div>
    </div>
    <div class="modal-body" id="modalPerfBody">
      <div class="charts-container">
        <div class="chart-card"><canvas id="chartPrisoes"></canvas></div>
        <div class="chart-card"><canvas id="chartArmas"></canvas></div>
      </div>
      <div class="charts-container">
        <div class="chart-card"><canvas id="chartOperacoes"></canvas></div>
        <div class="chart-card"><canvas id="chartPizza"></canvas></div>
      </div>

      <h3 style="margin:50px 0 20px; color:var(--primary); text-align:center;">
        <i class="fas fa-building"></i> Resumo por Departamento
      </h3>
      <div class="depto-resumo" id="deptoResumo"></div>

      <h3 style="margin:60px 0 20px; color:var(--primary); text-align:center;">
        <i class="fas fa-list-alt"></i> Registros Detalhados por Departamento
      </h3>
      <div id="registrosDetalhados"></div>
    </div>
  </div>
</div>

<!-- Modal Detalhes (Novo) -->
<div id="modalDetalhes" class="modalDetalhes">
  <div class="modalDetalhes-content">
    <div class="modal-header">
      <div id="modalDetalhesTitulo"></div>
      <div class="modal-actions">
        <button id="btnPdfDetalhes" class="btn-success">
          <i class="fas fa-file-pdf"></i> PDF Detalhado
        </button>
        <span class="close">√ó</span>
      </div>
    </div>
    <div class="modal-body" id="modalDetalhesBody"></div>
  </div>
</div>

<script>
// Conversor Excel ‚Üí DD/MM/AAAA
function converterDataExcel(serial) {
  if (!serial) return "";
  const num = Number(serial);
  if (isNaN(num) || num < 1) return String(serial).trim();
  const dias = Math.floor(num - 25569);
  const data = new Date(dias * 86400000);
  const d = String(data.getUTCDate()).padStart(2,'0');
  const m = String(data.getUTCMonth()+1).padStart(2,'0');
  const a = data.getUTCFullYear();
  return `${d}/${m}/${a}`;
}

let dadosOriginais = [];
let charts = {};
let dadosFiltradosAtual = [];
let modalDetalhesTipo = '';
let modalDetalhesDados = [];

// Upload
document.getElementById('uploadSection').onclick = () => document.getElementById('fileInput').click();

document.getElementById('fileInput').onchange = function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type:'array'});

      const sheetName = workbook.SheetNames.find(n => 
        n.toUpperCase().includes('REGISTRO') || 
        n.toUpperCase().includes('DADOS') ||
        n.toUpperCase().includes('OPERA√á√ïES')
      );
      if (!sheetName) throw new Error("Aba com dados n√£o encontrada!");

      const worksheet = workbook.Sheets[sheetName];
      const json = XLSX.utils.sheet_to_json(worksheet, {header:1, defval:""});

      const headers = json[0].map(h => String(h).trim());

      // CORRE√á√ÉO: Melhor limpeza e valida√ß√£o dos dados
      dadosOriginais = json.slice(1)
        .map(row => {
          let obj = {};
          headers.forEach((h,i) => {
            const v = row[i];
            // Tratamento especial para datas
            if (h === 'DT EVENTO' || h.includes('DATA')) {
              obj[h] = converterDataExcel(v);
            } else {
              obj[h] = String(v ?? '').trim();
            }
          });
          return obj;
        })
        .filter(r => 
          r['PRIS√ïES'].trim() !== '' ||
          r['ARMAS'].trim() !== '' ||
          r['MUNI√á√ïES'].trim() !== '' ||
          r['DROGAS (KG)'].trim() !== ''
        );

      // Ordenar por data decrescente
      dadosOriginais.sort((a,b) => {
        const da = a['DT EVENTO'] ? new Date(a['DT EVENTO'].split('/').reverse().join('-')) : new Date(0);
        const db = b['DT EVENTO'] ? new Date(b['DT EVENTO'].split('/').reverse().join('-')) : new Date(0);
        return db - da;
      });

      document.getElementById('status').textContent = `‚úÖ Sucesso! ${dadosOriginais.length} registros importados`;
      document.getElementById('status').classList.remove('hidden','error-status');
      document.getElementById('uploadSection').classList.add('hidden');
      document.getElementById('mainControls').classList.remove('hidden');

      popularFiltros();
      aplicarFiltros();

    } catch (err) {
      document.getElementById('status').textContent = `‚ùå Erro: ${err.message}`;
      document.getElementById('status').classList.add('error-status');
      document.getElementById('status').classList.remove('hidden');
      console.error('Erro no processamento:', err);
    }
  };
  reader.readAsArrayBuffer(file);
};

function popularFiltros() {
  // CORRE√á√ÉO: Melhor extra√ß√£o de valores √∫nicos com valida√ß√£o
  const unique = campo => {
    const valores = dadosOriginais
      .map(r => r[campo])
      .filter(v => v && v.trim() !== '')
      .map(v => v.trim());
    return [...new Set(valores)].sort();
  };

  const popular = (id, valores, labelTodos) => {
    const select = document.getElementById(id);
    select.innerHTML = `<option value="">${labelTodos}</option>`;
    valores.forEach(v => select.add(new Option(v, v)));
  };

  popular('filterDepto', unique('DEPTO'), 'Todos os Departamentos');
  popular('filterUnid', unique('UNID (DP)'), 'Todas as Unidades');
  popular('filterLocal', unique('LOCAL'), 'Todos os Locais');
  popular('filterFaccao', unique('FAC√á√ÉO'), 'Todas as Fac√ß√µes');
  
  document.querySelectorAll('select').forEach(s => s.onchange = aplicarFiltros);
}

function getDadosFiltrados() {
  let dados = [...dadosOriginais];
  
  // CORRE√á√ÉO: Filtragem mais robusta
  const filtros = [
    {id: 'Depto', campo: 'DEPTO'},
    {id: 'Unid', campo: 'UNID (DP)'},
    {id: 'Local', campo: 'LOCAL'},
    {id: 'Faccao', campo: 'FAC√á√ÉO'}
  ];

  filtros.forEach(filtro => {
    const valor = document.getElementById('filter' + filtro.id).value;
    if (valor && valor !== '') {
      dados = dados.filter(r => 
        r[filtro.campo] && r[filtro.campo].trim() === valor
      );
    }
  });

  return dados;
}

function aplicarFiltros() { 
  dadosFiltradosAtual = getDadosFiltrados();
  mostrarDashboard(dadosFiltradosAtual); 
}

// NOVO: Cards do Dashboard com Modal de Detalhes
function mostrarDashboard(dados) {
  const dashboard = document.getElementById('dashboard');
  
  // Limpar dashboard
  dashboard.innerHTML = '';
  
  // Calcular m√©tricas
  const totalRegistros = dados.length;
  const totalPrisoes = dados.reduce((a, r) => a + (r['PRIS√ïES'].trim() !== '' ? 1 : 0), 0);
  const totalArmas = dados.reduce((a, r) => a + (r['ARMAS'].trim() !== '' ? 1 : 0), 0);
  const totalMunicoes = dados.reduce((a, r) => a + (r['MUNI√á√ïES'].trim() !== '' ? 1 : 0), 0);
  const totalDrogas = dados.reduce((a, r) => a + (r['DROGAS (KG)'].trim() !== '' ? 1 : 0), 0);
  const locaisUnicos = new Set(dados.map(r => r['LOCAL']).filter(Boolean)).size;
  const unidadesUnicas = new Set(dados.map(r => r['UNID (DP)']).filter(Boolean)).size;
  
  // Preparar dados para cada card
  const cards = [
    {
      id: 'registros',
      titulo: 'Registros',
      subtitulo: 'Total de entradas registradas',
      valor: totalRegistros,
      icone: 'fa-clipboard-list',
      cor: '#3b82f6',
      corEscura: '#1e3a8a',
      dados: dados.map(r => ({
        ro: r['REG OCOR'] || 'N/A',
        data: r['DT EVENTO'] || '',
        local: r['LOCAL'] || '',
        depto: r['DEPTO'] || '',
        valor: 1
      }))
    },
    {
      id: 'prisoes',
      titulo: 'Pris√µes',
      subtitulo: 'Pris√µes efetuadas',
      valor: totalPrisoes,
      icone: 'fa-handcuffs',
      cor: '#dc2626',
      corEscura: '#991b1b',
      dados: dados.filter(r => r['PRIS√ïES'].trim() !== '').map(r => ({
        ro: r['REG OCOR'] || 'N/A',
        data: r['DT EVENTO'] || '',
        local: r['LOCAL'] || '',
        depto: r['DEPTO'] || '',
        valor: r['PRIS√ïES']
      }))
    },
    {
      id: 'armas',
      titulo: 'Armas',
      subtitulo: 'Apreens√µes de armas',
      valor: totalArmas,
      icone: 'fa-gun',
      cor: '#f59e0b',
      corEscura: '#d97706',
      dados: dados.filter(r => r['ARMAS'].trim() !== '').map(r => ({
        ro: r['REG OCOR'] || 'N/A',
        data: r['DT EVENTO'] || '',
        local: r['LOCAL'] || '',
        depto: r['DEPTO'] || '',
        valor: r['ARMAS']
      }))
    },
    {
      id: 'municoes',
      titulo: 'Muni√ß√µes',
      subtitulo: 'Apreens√µes de muni√ß√µes',
      valor: totalMunicoes,
      icone: 'fa-bullseye',
      cor: '#8b5cf6',
      corEscura: '#7c3aed',
      dados: dados.filter(r => r['MUNI√á√ïES'].trim() !== '').map(r => ({
        ro: r['REG OCOR'] || 'N/A',
        data: r['DT EVENTO'] || '',
        local: r['LOCAL'] || '',
        depto: r['DEPTO'] || '',
        valor: r['MUNI√á√ïES']
      }))
    },
    {
      id: 'drogas',
      titulo: 'Drogas',
      subtitulo: 'Apreens√µes de drogas',
      valor: totalDrogas,
      icone: 'fa-capsules',
      cor: '#059669',
      corEscura: '#047857',
      dados: dados.filter(r => r['DROGAS (KG)'].trim() !== '').map(r => ({
        ro: r['REG OCOR'] || 'N/A',
        data: r['DT EVENTO'] || '',
        local: r['LOCAL'] || '',
        depto: r['DEPTO'] || '',
        valor: r['DROGAS (KG)']
      }))
    },
    {
      id: 'locais',
      titulo: 'Locais',
      subtitulo: 'Locais diferentes atuados',
      valor: locaisUnicos,
      icone: 'fa-map-marker-alt',
      cor: '#06b6d4',
      corEscura: '#0891b2',
      dados: [...new Set(dados.map(r => r['LOCAL']).filter(Boolean))].map(local => ({
        local: local,
        quantidade: dados.filter(r => r['LOCAL'] === local).length,
        registros: dados.filter(r => r['LOCAL'] === local).map(r => r['REG OCOR']).join(', ')
      }))
    }
  ];

  // Criar cards
  cards.forEach(card => {
    const cardElement = document.createElement('div');
    cardElement.className = 'dashboard-card';
    cardElement.style.setProperty('--card-color', card.cor);
    cardElement.style.setProperty('--card-color-dark', card.corEscura);
    cardElement.style.setProperty('--card-rgb', 
      parseInt(card.cor.slice(1,3), 16) + ',' +
      parseInt(card.cor.slice(3,5), 16) + ',' +
      parseInt(card.cor.slice(5,7), 16)
    );

    cardElement.innerHTML = `
      <div class="card-header">
        <div class="card-icon">
          <i class="fas ${card.icone}"></i>
        </div>
        <div>
          <h3 class="card-title">${card.titulo}</h3>
          <p class="card-subtitle">${card.subtitulo}</p>
        </div>
      </div>
      <div class="card-value">${card.valor}</div>
      <div class="card-trend">
        <i class="fas fa-chart-line"></i>
        <span>${card.dados.length} registros com dados</span>
      </div>
      <div class="card-action" onclick="mostrarDetalhes('${card.id}', '${card.titulo}')">
        <i class="fas fa-search"></i>
        Ver Detalhes
      </div>
    `;

    dashboard.appendChild(cardElement);
  });
}

// NOVO: Mostrar modal com detalhes dos cards
function mostrarDetalhes(tipo, titulo) {
  modalDetalhesTipo = tipo;
  
  // Encontrar o card correspondente
  const card = {
    'registros': {
      titulo: 'Detalhes dos Registros',
      descricao: 'Lista completa de opera√ß√µes registradas',
      dados: dadosFiltradosAtual
    },
    'prisoes': {
      titulo: 'Detalhes das Pris√µes',
      descricao: 'Registros de pris√µes efetuadas',
      dados: dadosFiltradosAtual.filter(r => r['PRIS√ïES'].trim() !== '')
    },
    'armas': {
      titulo: 'Detalhes das Armas',
      descricao: 'Registros de apreens√£o de armas',
      dados: dadosFiltradosAtual.filter(r => r['ARMAS'].trim() !== '')
    },
    'municoes': {
      titulo: 'Detalhes das Muni√ß√µes',
      descricao: 'Registros de apreens√£o de muni√ß√µes',
      dados: dadosFiltradosAtual.filter(r => r['MUNI√á√ïES'].trim() !== '')
    },
    'drogas': {
      titulo: 'Detalhes das Drogas',
      descricao: 'Registros de apreens√£o de drogas',
      dados: dadosFiltradosAtual.filter(r => r['DROGAS (KG)'].trim() !== '')
    },
    'locais': {
      titulo: 'Locais Atuados',
      descricao: 'Locais onde ocorreram opera√ß√µes',
      dados: [...new Set(dadosFiltradosAtual.map(r => r['LOCAL']).filter(Boolean))]
    }
  }[tipo] || { titulo: 'Detalhes', dados: [] };

  modalDetalhesDados = card.dados;
  
  // Atualizar t√≠tulo do modal
  document.getElementById('modalDetalhesTitulo').innerHTML = 
    `<i class="fas fa-chart-pie"></i> ${card.titulo}`;
  
  // Atualizar conte√∫do do modal
  const modalBody = document.getElementById('modalDetalhesBody');
  
  if (tipo === 'locais') {
    // Formato especial para locais
    const locaisAgrupados = {};
    dadosFiltradosAtual.forEach(r => {
      const local = r['LOCAL'];
      if (local) {
        if (!locaisAgrupados[local]) {
          locaisAgrupados[local] = {
            count: 0,
            prisoes: 0,
            armas: 0,
            registros: []
          };
        }
        locaisAgrupados[local].count++;
        locaisAgrupados[local].prisoes += r['PRIS√ïES'].trim() !== '' ? 1 : 0;
        locaisAgrupados[local].armas += r['ARMAS'].trim() !== '' ? 1 : 0;
        locaisAgrupados[local].registros.push(r['REG OCOR'] || 'N/A');
      }
    });

    modalBody.innerHTML = `
      <p style="color: #64748b; margin-bottom: 30px;">${card.descricao} - ${card.dados.length} locais encontrados</p>
      <div class="detalhes-lista">
        ${Object.entries(locaisAgrupados)
          .sort((a, b) => b[1].count - a[1].count)
          .map(([local, info]) => `
            <div class="detalhe-item">
              <div class="detalhe-info">
                <span class="detalhe-valor">${local}</span>
                <div style="display: flex; gap: 20px; margin-top: 10px;">
                  <span style="color: #dc2626;"><i class="fas fa-handcuffs"></i> ${info.prisoes} pris√µes</span>
                  <span style="color: #f59e0b;"><i class="fas fa-gun"></i> ${info.armas} apreens√µes de armas</span>
                  <span style="color: #3b82f6;"><i class="fas fa-clipboard-list"></i> ${info.count} entradas</span>
                </div>
              </div>
              <div>
                <span class="detalhe-data">ROs: ${info.registros.slice(0, 3).join(', ')}${info.registros.length > 3 ? '...' : ''}</span>
              </div>
            </div>
          `).join('')}
      </div>
    `;
  } else {
    // Formato padr√£o para outros cards
    modalBody.innerHTML = `
      <p style="color: #64748b; margin-bottom: 30px;">${card.descricao} - ${card.dados.length} registros encontrados</p>
      <div class="detalhes-lista">
        ${card.dados.slice(0, 50).map(r => `
          <div class="detalhe-item">
            <div class="detalhe-info">
              <span class="detalhe-valor">${
                tipo === 'registros' ? 'RO: ' + (r['REG OCOR'] || 'N/A') :
                tipo === 'prisoes' ? r['PRIS√ïES'] :
                tipo === 'armas' ? r['ARMAS'] :
                tipo === 'municoes' ? r['MUNI√á√ïES'] :
                tipo === 'drogas' ? r['DROGAS (KG)'] : ''
              }</span>
              <span class="detalhe-local">${r['LOCAL'] || 'Local n√£o informado'} - ${r['DEPTO'] || 'Depto n√£o informado'}</span>
            </div>
            <div>
              <span class="detalhe-data">${r['DT EVENTO'] || 'Data n√£o informada'}</span>
            </div>
          </div>
        `).join('')}
        ${card.dados.length > 50 ? 
          `<p style="text-align: center; color: #64748b; margin-top: 20px;">
            ... e mais ${card.dados.length - 50} registros
          </p>` : ''}
      </div>
    `;
  }
  
  // Mostrar modal
  document.getElementById('modalDetalhes').style.display = 'flex';
}

// NOVO: Gerar PDF com cards para detalhes
document.getElementById('btnPdfDetalhes').onclick = function() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"portrait",unit:"mm",format:"a4"});
  
  const cardInfo = {
    'registros': { titulo: 'Registros', icone: 'üìã', cor: [59, 130, 246] },
    'prisoes': { titulo: 'Pris√µes', icone: 'üîó', cor: [220, 38, 38] },
    'armas': { titulo: 'Armas', icone: 'üî´', cor: [245, 158, 11] },
    'municoes': { titulo: 'Muni√ß√µes', icone: 'üéØ', cor: [139, 92, 246] },
    'drogas': { titulo: 'Drogas', icone: 'üíä', cor: [5, 150, 105] },
    'locais': { titulo: 'Locais', icone: 'üìç', cor: [6, 182, 212] }
  }[modalDetalhesTipo] || { titulo: 'Detalhes', icone: 'üìä', cor: [59, 130, 246] };
  
  // Cabe√ßalho
  doc.setFillColor(30, 64, 175);
  doc.rect(0, 0, 210, 40, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(20);
  doc.setFont(undefined, 'bold');
  doc.text(`DETALHES: ${cardInfo.titulo}`, 105, 18, {align:"center"});
  doc.setFontSize(11);
  doc.setFont(undefined, 'normal');
  doc.text(`OP BZERO - Sistema de Intelig√™ncia Policial`, 105, 28, {align:"center"});
  doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 34, {align:"center"});
  
  doc.setTextColor(0, 0, 0);
  
  // Card visual no PDF
  let y = 50;
  doc.setFillColor(cardInfo.cor[0], cardInfo.cor[1], cardInfo.cor[2]);
  doc.roundedRect(20, y, 170, 40, 5, 5, 'F');
  
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(28);
  doc.text(cardInfo.icone, 35, y + 25);
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.text(cardInfo.titulo, 55, y + 20);
  
  let valor = '0';
  if (modalDetalhesTipo === 'registros') valor = dadosFiltradosAtual.length;
  if (modalDetalhesTipo === 'prisoes') valor = dadosFiltradosAtual.reduce((a, r) => a + (r['PRIS√ïES'].trim() !== '' ? 1 : 0), 0);
  if (modalDetalhesTipo === 'armas') valor = dadosFiltradosAtual.reduce((a, r) => a + (r['ARMAS'].trim() !== '' ? 1 : 0), 0);
  if (modalDetalhesTipo === 'municoes') valor = dadosFiltradosAtual.reduce((a, r) => a + (r['MUNI√á√ïES'].trim() !== '' ? 1 : 0), 0);
  if (modalDetalhesTipo === 'drogas') valor = dadosFiltradosAtual.reduce((a, r) => a + (r['DROGAS (KG)'].trim() !== '' ? 1 : 0), 0);
  if (modalDetalhesTipo === 'locais') valor = new Set(dadosFiltradosAtual.map(r => r['LOCAL']).filter(Boolean)).size;
  
  doc.setFontSize(36);
  doc.text(String(valor), 160, y + 25, {align:"right"});
  
  y += 60;
  
  // Resumo
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text("RESUMO DETALHADO", 105, y, {align:"center"});
  y += 10;
  
  // Tabela de resumo
  const resumoData = [];
  modalDetalhesDados.slice(0, 20).forEach((item, index) => {
    if (modalDetalhesTipo === 'locais') {
      const registrosNoLocal = dadosFiltradosAtual.filter(r => r['LOCAL'] === item);
      resumoData.push([
        item || 'N√£o informado',
        registrosNoLocal.length,
        registrosNoLocal.reduce((a, r) => a + (r['PRIS√ïES'].trim() !== '' ? 1 : 0), 0),
        registrosNoLocal.reduce((a, r) => a + (r['ARMAS'].trim() !== '' ? 1 : 0), 0)
      ]);
    } else {
      resumoData.push([
        item['REG OCOR'] || 'N/A',
        item['DT EVENTO'] || '',
        item['LOCAL'] || '',
        item['DEPTO'] || '',
        item.valor
      ]);
    }
  });
  
  const headers = modalDetalhesTipo === 'locais' 
    ? ['Local', 'Entradas', 'Pris√µes', 'Apreens√µes de Armas']
    : ['RO', 'Data', 'Local', 'Departamento', 'Detalhe'];
  
  doc.autoTable({
    head: [headers],
    body: resumoData,
    startY: y,
    theme: 'grid',
    headStyles: {fillColor: cardInfo.cor, fontSize: 10, fontStyle: 'bold', textColor: [255, 255, 255]},
    styles: {fontSize: 9, cellPadding: 3},
    margin: {left: 20, right: 20}
  });
  
  y = doc.lastAutoTable.finalY + 15;
  
  if (modalDetalhesDados.length > 20) {
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text(`... e mais ${modalDetalhesDados.length - 20} registros`, 105, y, {align:"center"});
  }
  
  // Rodap√©
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    doc.text(`P√°gina ${i} de ${pageCount}`, 105, 290, {align: "center"});
    doc.text("OPERA√á√ÉO BARRICADA ZERO - Sistema de Intelig√™ncia Operacional", 105, 295, {align: "center"});
  }
  
  doc.save(`OP_BZERO_Detalhes_${cardInfo.titulo}_${new Date().toISOString().slice(0,10)}.pdf`);
};

// PERFORMANCE DETALHADA (mantida)
document.getElementById('btnAnalise').onclick = () => {
  const dados = getDadosFiltrados();
  dadosFiltradosAtual = dados;

  // Agrupamento por DEPTO
  const porDepto = {};
  dados.forEach(r => {
    const d = r['DEPTO'] || 'N√£o Informado';
    if(!porDepto[d]) porDepto[d] = {ops:0,pris:0,arm:0,regs:[]};
    porDepto[d].ops++;
    porDepto[d].pris += r['PRIS√ïES'].trim() !== '' ? 1 : 0;
    porDepto[d].arm += r['ARMAS'].trim() !== '' ? 1 : 0;
    porDepto[d].regs.push(r);
  });

  const labels = Object.keys(porDepto);
  const ops = labels.map(k=>porDepto[k].ops);
  const pris = labels.map(k=>porDepto[k].pris);
  const armas = labels.map(k=>porDepto[k].arm);

  // Destruir gr√°ficos anteriores
  Object.values(charts).forEach(ch => ch?.destroy());

  charts.prisoes = new Chart(document.getElementById('chartPrisoes'), {
    type:'bar', 
    data:{
      labels, 
      datasets:[{
        label:'Pris√µes',
        data:pris,
        backgroundColor:'#dc2626',
        borderRadius: 8
      }]
    }, 
    options:{
      plugins:{
        title:{
          display:true,
          text:'Pris√µes por Departamento',
          font: {size: 16, weight: 'bold'}
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          grid: {color: 'rgba(0,0,0,0.05)'}
        },
        x: {
          grid: {display: false}
        }
      }
    }
  });
  
  charts.armas = new Chart(document.getElementById('chartArmas'), {
    type:'bar', 
    data:{
      labels, 
      datasets:[{
        label:'Apreens√µes de Armas',
        data:armas,
        backgroundColor:'#f59e0b',
        borderRadius: 8
      }]
    }, 
    options:{
      plugins:{
        title:{
          display:true,
          text:'Apreens√µes de Armas por Departamento',
          font: {size: 16, weight: 'bold'}
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          grid: {color: 'rgba(0,0,0,0.05)'}
        },
        x: {
          grid: {display: false}
        }
      }
    }
  });
  
  charts.ops = new Chart(document.getElementById('chartOperacoes'), {
    type:'bar', 
    data:{
      labels, 
      datasets:[{
        label:'Opera√ß√µes',
        data:ops,
        backgroundColor:'#3b82f6',
        borderRadius: 8
      }]
    }, 
    options:{
      plugins:{
        title:{
          display:true,
          text:'Opera√ß√µes por Departamento',
          font: {size: 16, weight: 'bold'}
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          grid: {color: 'rgba(0,0,0,0.05)'}
        },
        x: {
          grid: {display: false}
        }
      }
    }
  });
  
  charts.pizza = new Chart(document.getElementById('chartPizza'), {
    type:'pie', 
    data:{
      labels, 
      datasets:[{
        data:ops,
        backgroundColor:['#3b82f6','#10b981','#f59e0b','#dc2626','#8b5cf6','#06b6d4','#f97316','#8b5cf6'],
        borderWidth: 2,
        borderColor: '#ffffff'
      }]
    }, 
    options:{
      plugins:{
        title:{
          display:true,
          text:'Distribui√ß√£o de Opera√ß√µes',
          font: {size: 16, weight: 'bold'}
        },
        legend: {
          position: 'right',
          labels: {font: {size: 12}}
        }
      }
    }
  });

  // Cards de resumo por DEPTO
  const resumoDiv = document.getElementById('deptoResumo');
  resumoDiv.innerHTML = '';
  Object.entries(porDepto).sort((a,b)=>b[1].ops - a[1].ops).forEach(([depto, info]) => {
    const media = ((info.pris + info.arm) / info.ops).toFixed(2);
    const card = document.createElement('div');
    card.className = 'depto-card';
    card.innerHTML = `
      <h4>${depto}</h4>
      <div class="stats">
        <div><strong>${info.ops}</strong> <span>opera√ß√µes</span></div>
        <div><strong>${info.pris}</strong> <span>pris√µes</span></div>
        <div><strong>${info.arm}</strong> <span>apreens√µes de armas</span></div>
        <div><strong>${media}</strong> <span>m√©dia/op</span></div>
      </div>
    `;
    resumoDiv.appendChild(card);
  });

  // Registros detalhados por DEPTO
  const detalhesDiv = document.getElementById('registrosDetalhados');
  detalhesDiv.innerHTML = '';
  Object.entries(porDepto).sort((a,b)=>b[1].ops - a[1].ops).forEach(([depto, info]) => {
    const div = document.createElement('div');
    div.className = 'registros-depto';
    div.innerHTML = `<h4><i class="fas fa-building"></i> ${depto} ‚Äî ${info.ops} registros</h4>`;
    const table = document.createElement('table');
    table.innerHTML = `
      <thead>
        <tr>
          <th>RO</th>
          <th>DATA</th>
          <th>UNID</th>
          <th>LOCAL</th>
          <th>PRIS√ïES</th>
          <th>ARMAS</th>
          <th>MUNI√á√ïES</th>
        </tr>
      </thead>
      <tbody>
        ${info.regs.map(r=>`
          <tr>
            <td>${r['REG OCOR']||''}</td>
            <td>${r['DT EVENTO']||''}</td>
            <td>${r['UNID (DP)']||''}</td>
            <td>${r['LOCAL']||''}</td>
            <td style="color: #dc2626; font-weight: bold;">${r['PRIS√ïES']||''}</td>
            <td style="color: #f59e0b; font-weight: bold;">${r['ARMAS']||''}</td>
            <td style="color: #8b5cf6; font-weight: bold;">${r['MUNI√á√ïES']||''}</td>
          </tr>
        `).join('')}
      </tbody>
    `;
    div.appendChild(table);
    detalhesDiv.appendChild(div);
  });

  document.getElementById('modalPerf').style.display='flex';
};

// NOVO: Gerar PDF para o modal de performance (horizontal)
document.getElementById('btnPdfPerf').onclick = function() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"landscape",unit:"mm",format:"a4"});
  const dados = dadosFiltradosAtual;

  // Cabe√ßalho
  doc.setFillColor(30, 64, 175);
  doc.rect(0, 0, 297, 40, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(24);
  doc.setFont(undefined, 'bold');
  doc.text("AN√ÅLISE DE PERFORMANCE POR DEPARTAMENTO", 148, 18, {align:"center"});
  doc.setFontSize(11);
  doc.setFont(undefined, 'normal');
  doc.text(`OPera√ß√£o barricada Zero - Sistema de Intelig√™ncia Operacional`, 148, 28, {align:"center"});
  doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 148, 34, {align:"center"});

  doc.setTextColor(0, 0, 0);

  let y = 50;

  // Gr√°ficos
  const addChart = (id, title, xPos, yPos, width, height) => {
    const canvas = document.getElementById(id);
    if (!canvas) return;
    const img = canvas.toDataURL("image/png");
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(30, 64, 175);
    doc.text(title, xPos + width / 2, yPos - 5, {align:"center"});
    doc.addImage(img, 'PNG', xPos, yPos, width, height);
  };

  // Adicionar gr√°ficos em layout horizontal
  addChart('chartPrisoes', 'Pris√µes por Departamento', 10, y, 130, 80);
  addChart('chartArmas', 'Apreens√µes de Armas por Departamento', 150, y, 130, 80);
  y += 90;
  addChart('chartOperacoes', 'Opera√ß√µes por Departamento', 10, y, 130, 80);
  addChart('chartPizza', 'Distribui√ß√£o de Opera√ß√µes', 150, y, 130, 80);
  y += 90;

  // Resumo por Departamento
  if (y > 150) {
    doc.addPage();
    y = 20;
  }
  doc.setFontSize(16);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(30, 64, 175);
  doc.text("RESUMO POR DEPARTAMENTO", 148, y, {align:"center"});
  y += 10;

  const porDepto = {};
  dados.forEach(r => {
    const d = r['DEPTO'] || 'N√£o Informado';
    if (!porDepto[d]) porDepto[d] = {ops: 0, pris: 0, arm: 0, mun: 0, drog: 0};
    porDepto[d].ops++;
    porDepto[d].pris += r['PRIS√ïES'].trim() !== '' ? 1 : 0;
    porDepto[d].arm += r['ARMAS'].trim() !== '' ? 1 : 0;
    porDepto[d].mun += r['MUNI√á√ïES'].trim() !== '' ? 1 : 0;
    porDepto[d].drog += r['DROGAS (KG)'].trim() !== '' ? 1 : 0;
  });

  const resumoBody = Object.entries(porDepto).sort((a, b) => b[1].ops - a[1].ops).map(([depto, info]) => [
    depto,
    info.ops,
    info.pris,
    info.arm,
    info.mun,
    info.drog,
    ((info.pris + info.arm) / info.ops).toFixed(2)
  ]);

  doc.autoTable({
    head: [['Departamento', 'Opera√ß√µes', 'Pris√µes', 'Apreens√µes de Armas', 'Apreens√µes de Muni√ß√µes', 'Apreens√µes de Drogas', 'M√©dia/Op']],
    body: resumoBody,
    startY: y,
    theme: 'grid',
    headStyles: {fillColor: [30, 64, 175], fontSize: 10, fontStyle: 'bold', textColor: [255, 255, 255]},
    styles: {fontSize: 9, cellPadding: 3},
    margin: {left: 10, right: 10}
  });

  y = doc.lastAutoTable.finalY + 15;

  // Registros Detalhados por Departamento
  if (y > 150) {
    doc.addPage();
    y = 20;
  }
  doc.setFontSize(16);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(30, 64, 175);
  doc.text("REGISTROS DETALHADOS POR DEPARTAMENTO", 148, y, {align:"center"});
  y += 10;

  Object.entries(porDepto).sort((a, b) => b[1].ops - a[1].ops).forEach(([depto, info]) => {
    if (y > 150) {
      doc.addPage();
      y = 20;
    }
    doc.setFontSize(12);
    doc.text(`${depto} ‚Äî ${info.ops} registros`, 148, y, {align:"center"});
    y += 10;

    const tableBody = info.regs.map(r => [
      r['REG OCOR'] || '',
      r['DT EVENTO'] || '',
      r['UNID (DP)'] || '',
      r['LOCAL'] || '',
      r['PRIS√ïES'] || '',
      r['ARMAS'] || '',
      r['MUNI√á√ïES'] || ''
    ]);

    doc.autoTable({
      head: [['RO', 'DATA', 'UNID', 'LOCAL', 'PRIS√ïES', 'ARMAS', 'MUNI√á√ïES']],
      body: tableBody,
      startY: y,
      theme: 'grid',
      headStyles: {fillColor: [30, 64, 175], fontSize: 9, fontStyle: 'bold', textColor: [255, 255, 255]},
      styles: {fontSize: 8, cellPadding: 2},
      margin: {left: 10, right: 10}
    });

    y = doc.lastAutoTable.finalY + 15;
  });

  // Rodap√©
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    doc.text(`P√°gina ${i} de ${pageCount}`, 148, 200, {align: "center"});
    doc.text("OPERA√á√ÉO BARRICADA ZERO - Sistema de Intelig√™ncia Operacional", 148, 205, {align: "center"});
  }

  doc.save(`OP_BZERO_Performance_${new Date().toISOString().slice(0,10)}.pdf`);
};

// Exportar para Excel (mantida)
document.getElementById('btnExportarExcel').onclick = () => {
  const dados = dadosFiltradosAtual;
  
  // Criar workbook
  const wb = XLSX.utils.book_new();
  
  // ABA 1: Resumo Geral
  const resumoData = [
    ['OPERA√á√ÉO BARRICADA ZERO - RELAT√ìRIO DE AN√ÅLISE'],
    ['Gerado em:', new Date().toLocaleString('pt-BR')],
    [''],
    ['INDICADORES GERAIS'],
    ['Total de Registros', dados.length],
    ['Pris√µes Efetuadas', dados.reduce((a,r)=>a + (r['PRIS√ïES'].trim() !== '' ? 1 : 0),0)],
    ['Apreens√µes de Armas', dados.reduce((a,r)=>a + (r['ARMAS'].trim() !== '' ? 1 : 0),0)],
    ['Apreens√µes de Muni√ß√µes', dados.reduce((a,r)=>a + (r['MUNI√á√ïES'].trim() !== '' ? 1 : 0),0)],
    ['Apreens√µes de Drogas', dados.reduce((a,r)=>a + (r['DROGAS (KG)'].trim() !== '' ? 1 : 0),0)],
    ['Locais Atuados', new Set(dados.map(r=>r['LOCAL']).filter(Boolean)).size],
    ['Departamentos Envolvidos', new Set(dados.map(r=>r['DEPTO']).filter(Boolean)).size]
  ];
  const wsResumo = XLSX.utils.aoa_to_sheet(resumoData);
  XLSX.utils.book_append_sheet(wb, wsResumo, 'Resumo Geral');
  
  // ABA 2: Performance por Departamento
  const porDepto = {};
  dados.forEach(r => {
    const d = r['DEPTO'] || 'N√£o Informado';
    if(!porDepto[d]) porDepto[d] = {ops:0,pris:0,arm:0,mun:0,drog:0};
    porDepto[d].ops++;
    porDepto[d].pris += r['PRIS√ïES'].trim() !== '' ? 1 : 0;
    porDepto[d].arm += r['ARMAS'].trim() !== '' ? 1 : 0;
    porDepto[d].mun += r['MUNI√á√ïES'].trim() !== '' ? 1 : 0;
    porDepto[d].drog += r['DROGAS (KG)'].trim() !== '' ? 1 : 0;
  });
  
  const perfData = [
    ['PERFORMANCE POR DEPARTAMENTO'],
    [''],
    ['Departamento', 'Opera√ß√µes', 'Pris√µes', 'Apreens√µes de Armas', 'Apreens√µes de Muni√ß√µes', 'Apreens√µes de Drogas', 'M√©dia Result./Op']
  ];
  
  Object.entries(porDepto).sort((a,b)=>b[1].ops-a[1].ops).forEach(([dept, info]) => {
    const media = ((info.pris + info.arm) / info.ops).toFixed(2);
    perfData.push([dept, info.ops, info.pris, info.arm, info.mun, info.drog, media]);
  });
  
  const wsPerf = XLSX.utils.aoa_to_sheet(perfData);
  XLSX.utils.book_append_sheet(wb, wsPerf, 'Performance Departamentos');
  
  // ABA 3: Dados Completos
  const headers = ['DEPTO', 'UNID (DP)', 'REG OCOR', 'DT EVENTO', 'LOCAL', 'FAC√á√ÉO', 'PRIS√ïES', 'ARMAS', 'MUNI√á√ïES', 'DROGAS (KG)'];
  const dadosCompletos = [headers];
  
  dados.forEach(r => {
    dadosCompletos.push([
      r['DEPTO'] || '',
      r['UNID (DP)'] || '',
      r['REG OCOR'] || '',
      r['DT EVENTO'] || '',
      r['LOCAL'] || '',
      r['FAC√á√ÉO'] || '',
      r['PRIS√ïES'] || '',
      r['ARMAS'] || '',
      r['MUNI√á√ïES'] || '',
      r['DROGAS (KG)'] || ''
    ]);
  });
  
  const wsDados = XLSX.utils.aoa_to_sheet(dadosCompletos);
  XLSX.utils.book_append_sheet(wb, wsDados, 'Dados Completos');
  
  // Salvar arquivo
  const nomeArquivo = `OP_BZERO_Analise_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.writeFile(wb, nomeArquivo);
  
  alert(`‚úÖ Planilha Excel exportada com sucesso!\nArquivo: ${nomeArquivo}`);
};

// Fechar modais
document.querySelectorAll('.close').forEach(c => 
  c.onclick = () => c.closest('.modal,.modalPerf,.modalDetalhes').style.display = 'none'
);

window.onclick = e => {
  if (e.target.classList.contains('modal') || 
      e.target.classList.contains('modalPerf') || 
      e.target.classList.contains('modalDetalhes')) {
    e.target.style.display = 'none';
  }
};

// PDF Completo (atualizado com cards visuais)
document.getElementById('btnPdf').onclick = () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"landscape",unit:"mm",format:"a4"});
  const dados = getDadosFiltrados();

  // Cabe√ßalho
  doc.setFillColor(30, 64, 175);
  doc.rect(0, 0, 297, 40, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(24);
  doc.setFont(undefined, 'bold');
  doc.text("RELAT√ìRIO COMPLETO OPERA√á√ÉO BARRICADA ZERO", 148, 18, {align:"center"});
  doc.setFontSize(11);
  doc.setFont(undefined, 'normal');
  doc.text(`Sistema de Intelig√™ncia Operacional - Gerado em: ${new Date().toLocaleString('pt-BR')}`, 148, 28, {align:"center"});
  
  doc.setTextColor(0, 0, 0);
  
  // ========== CARDS DE RESUMO VISUAIS ==========
  let y = 50;
  doc.setFontSize(16);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(30, 64, 175);
  doc.text("INDICADORES PRINCIPAIS", 148, y, {align:"center"});
  
  y += 10;
  
  const totalRegistros = dados.length;
  const totalPrisoes = dados.reduce((a,r)=>a + (r['PRIS√ïES'].trim() !== '' ? 1 : 0),0);
  const totalArmas = dados.reduce((a,r)=>a + (r['ARMAS'].trim() !== '' ? 1 : 0),0);
  const totalMunicoes = dados.reduce((a,r)=>a + (r['MUNI√á√ïES'].trim() !== '' ? 1 : 0),0);
  const totalDrogas = dados.reduce((a,r)=>a + (r['DROGAS (KG)'].trim() !== '' ? 1 : 0),0);
  const totalLocais = new Set(dados.map(r=>r['LOCAL']).filter(Boolean)).size;
  const totalDeptos = new Set(dados.map(r=>r['DEPTO']).filter(Boolean)).size;
  
  // Fun√ß√£o para desenhar card visual
  const drawVisualCard = (x, y, titulo, valor, cor, icone) => {
    // Card background
    doc.setFillColor(cor.r, cor.g, cor.b);
    doc.roundedRect(x, y, 65, 32, 5, 5, 'F');
    
    // √çcone
    doc.setFontSize(20);
    doc.setTextColor(255, 255, 255);
    doc.text(icone, x + 12, y + 12);
    
    // T√≠tulo
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text(titulo, x + 30, y + 10, {align: "left"});
    
    // Valor
    doc.setFontSize(22);
    doc.setFont(undefined, 'bold');
    doc.text(String(valor), x + 32, y + 25, {align: "left"});
    
    // Borda sutil
    doc.setDrawColor(255, 255, 255);
    doc.setLineWidth(0.5);
    doc.roundedRect(x, y, 65, 32, 5, 5, 'S');
  };
  
  // Cores e √≠cones para os cards
  const cardsInfo = [
    {titulo: "Registros", valor: totalRegistros, cor: {r:59, g:130, b:246}, icone: "üìã"},
    {titulo: "Pris√µes", valor: totalPrisoes, cor: {r:220, g:38, b:38}, icone: "üîó"},
    {titulo: "Armas", valor: totalArmas, cor: {r:245, g:158, b:11}, icone: "üî´"},
    {titulo: "Muni√ß√µes", valor: totalMunicoes, cor: {r:139, g:92, b:246}, icone: "üéØ"},
  ];
  
  // Desenhar primeira linha de cards
  cardsInfo.forEach((card, i) => {
    const x = 20 + (i * 70);
    drawVisualCard(x, y, card.titulo, card.valor, card.cor, card.icone);
  });
  
  y += 40;
  
  // Segunda linha de cards
  const cardsInfo2 = [
    {titulo: "Drogas", valor: totalDrogas, cor: {r:16, g:185, b:129}, icone: "üíä"},
    {titulo: "Locais", valor: totalLocais, cor: {r:6, g:182, b:212}, icone: "üìç"},
    {titulo: "Deptos", valor: totalDeptos, cor: {r:249, g:115, b:22}, icone: "üè¢"},
  ];
  
  cardsInfo2.forEach((card, i) => {
    const x = 20 + (i * 70);
    drawVisualCard(x, y, card.titulo, card.valor, card.cor, card.icone);
  });
  
  y += 45;

  // Tabela resumo detalhada
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(30, 64, 175);
  doc.text("RESUMO DETALHADO", 148, y, {align:"center"});
  y += 5;
  
  doc.autoTable({
    head:[["Indicador","Total"]],
    body:[
      ["Total de Registros", totalRegistros],
      ["Pris√µes Efetuadas", totalPrisoes],
      ["Apreens√µes de Armas", totalArmas],
      ["Apreens√µes de Muni√ß√µes", totalMunicoes],
      ["Apreens√µes de Drogas", totalDrogas],
      ["Locais Atuados", totalLocais],
      ["Departamentos Envolvidos", totalDeptos]
    ],
    startY: y,
    theme: 'grid',
    headStyles: {fillColor: [30, 64, 175], fontSize: 11, fontStyle: 'bold', textColor: [255, 255, 255]},
    styles: {fontSize: 10, cellPadding: 3},
    columnStyles: {
      0: {fontStyle: 'bold', cellWidth: 80},
      1: {halign: 'center', cellWidth: 40}
    }
  });
  
  y = doc.lastAutoTable.finalY + 15;

  // Gr√°ficos
  const addChart = (id, title) => {
    if (y > 160) {
      doc.addPage();
      y = 20;
    }
    const canvas = document.getElementById(id);
    if (!canvas) return;
    const img = canvas.toDataURL("image/png");
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(30, 64, 175);
    doc.text(title, 148, y, {align:"center"});
    y += 5;
    doc.addImage(img, 'PNG', 10, y, 277, 100);
    y += 110;
  };

  if (Object.keys(charts).length > 0) {
    doc.addPage();
    y = 20;
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(30, 64, 175);
    doc.text("AN√ÅLISE GR√ÅFICA POR DEPARTAMENTO", 148, y, {align:"center"});
    y += 15;
    
    addChart('chartPrisoes', 'Pris√µes por Departamento');
    addChart('chartArmas', 'Apreens√µes de Armas por Departamento');
    addChart('chartOperacoes', 'Opera√ß√µes por Departamento');
    addChart('chartPizza', 'Distribui√ß√£o de Opera√ß√µes');
  }

  // Performance por departamento
  const porDepto = {};
  dados.forEach(r => {
    const d = r['DEPTO'] || 'N√£o Informado';
    if(!porDepto[d]) porDepto[d] = {ops:0,pris:0,arm:0,mun:0,drog:0};
    porDepto[d].ops++;
    porDepto[d].pris += r['PRIS√ïES'].trim() !== '' ? 1 : 0;
    porDepto[d].arm += r['ARMAS'].trim() !== '' ? 1 : 0;
    porDepto[d].mun += r['MUNI√á√ïES'].trim() !== '' ? 1 : 0;
    porDepto[d].drog += r['DROGAS (KG)'].trim() !== '' ? 1 : 0;
  });
  
  doc.addPage();
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(30, 64, 175);
  doc.text("PERFORMANCE POR DEPARTAMENTO", 148, 20, {align:"center"});
  
  const perfBody = Object.entries(porDepto).sort((a,b)=>b[1].ops-a[1].ops).map(([d,info]) => {
    const media = ((info.pris + info.arm)/info.ops).toFixed(2);
    return [d, info.ops, info.pris, info.arm, info.mun, info.drog, media];
  });
  
  doc.autoTable({
    head:[['Departamento', 'Opera√ß√µes', 'Pris√µes', 'Apreens√µes de Armas', 'Apreens√µes de Muni√ß√µes', 'Apreens√µes de Drogas', 'M√©dia/Op']],
    body: perfBody,
    startY: 30,
    theme: 'striped',
    headStyles: {fillColor: [30, 64, 175], fontSize: 10, fontStyle: 'bold', textColor: [255, 255, 255]},
    styles: {fontSize: 9, cellPadding: 2.5},
    columnStyles: {
      0: {cellWidth: 60},
      1: {halign: 'center', cellWidth: 25},
      2: {halign: 'center', cellWidth: 25},
      3: {halign: 'center', cellWidth: 25},
      4: {halign: 'center', cellWidth: 30},
      5: {halign: 'center', cellWidth: 30},
      6: {halign: 'center', cellWidth: 25}
    }
  });

  // Tabela completa de registros
  doc.addPage();
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(30, 64, 175);
  doc.text("REGISTROS DETALHADOS", 148, 20, {align:"center"});
  
  doc.autoTable({
    head:[['DEPTO','UNID','RO','DATA','LOCAL','FAC√á√ÉO','PRIS√ïES','ARMAS','MUNI√á√ïES','DROGAS']],
    body: dados.map(r=>[
      r['DEPTO']||'', r['UNID (DP)']||'', r['REG OCOR']||'', r['DT EVENTO']||'',
      r['LOCAL']||'', r['FAC√á√ÉO']||'', r['PRIS√ïES']||'', r['ARMAS']||'', 
      r['MUNI√á√ïES']||'', r['DROGAS (KG)']||''
    ]),
    startY: 30,
    theme: 'striped',
    headStyles: {fillColor: [30, 64, 175], fontSize: 9, fontStyle: 'bold', textColor: [255, 255, 255]},
    styles: {fontSize: 8, cellPadding: 2},
    columnStyles: {
      0: {cellWidth: 25},
      1: {cellWidth: 20},
      2: {cellWidth: 25},
      3: {cellWidth: 23},
      4: {cellWidth: 45},
      5: {cellWidth: 25},
      6: {halign: 'center', cellWidth: 18},
      7: {halign: 'center', cellWidth: 18},
      8: {halign: 'center', cellWidth: 22},
      9: {halign: 'center', cellWidth: 20}
    }
  });

  // Rodap√© em todas as p√°ginas
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    doc.text(`P√°gina ${i} de ${pageCount}`, 148, 205, {align: "center"});
    doc.text("OPERA√á√ÉO BARRICADA ZERO - Intelig√™ncia Policial", 148, 200, {align: "center"});
  }

  doc.save(`OP_BZERO_Completo_${new Date().toISOString().slice(0,10)}.pdf`);
};
</script>
</body>
</html>
