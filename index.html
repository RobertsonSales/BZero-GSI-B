<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OPERAÇAO BARRICADA ZERO - Análise de Operações - PCERJ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    /* Estilos CSS (Mantidos da versão anterior) */
    :root { 
      --primary: #1e40af; 
      --success: #059669; 
      --gray: #f8fafc; 
      --danger: #dc2626; 
      --warning: #f59e0b;
      --purple: #8b5cf6;
      --cyan: #06b6d4;
    }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); 
      margin:0; 
      padding:20px; 
      color:#1e293b; 
      min-height: 10vh;
    }
    .container { 
      max-width:1600px; 
      margin:auto; 
      background:white; 
      border-radius:24px; 
      box-shadow:0 20px 60px rgba(0,0,0,0.15); 
      overflow:hidden; 
      position: relative;
    }
    header { 
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); 
      color:white; 
      padding:40px 30px; 
      text-align:center; 
      position: relative;
      overflow: hidden;
    }
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%233b82f6' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
      opacity: 0.3;
    }
    header h1 { 
      margin:0; 
      font-size:2.8rem; 
      font-weight:800; 
      letter-spacing: -0.5px;
      position: relative;
    }
    header p { 
      margin-top:15px; 
      opacity:0.95; 
      font-size:1.2rem;
      position: relative;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    .upload-area { 
      padding:100px 30px; 
      text-align:center; 
      border:3px dashed #94a3b8; 
      border-radius:24px; 
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      margin:40px; 
      cursor:pointer; 
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .upload-area::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent 30%, rgba(59, 130, 246, 0.1) 50%, transparent 70%);
      transition: transform 0.8s;
      transform: translateX(-100%);
    }
    .upload-area:hover::before {
      transform: translateX(100%);
    }
    .upload-area:hover { 
      border-color:var(--primary); 
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      transform: translateY(-8px) scale(1.01);
      box-shadow: 0 20px 40px rgba(30, 64, 175, 0.2);
    }
    .upload-area i { 
      font-size:80px; 
      color:#64748b; 
      margin-bottom:25px;
      position: relative;
    }
    .upload-area h3 {
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: #1e293b;
    }
    .upload-area p {
      color: #64748b;
      font-size: 1.1rem;
    }

    .controls { 
      padding:30px; 
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-bottom:1px solid #e2e8f0; 
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }
    .filter-row { 
      display:grid; 
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); 
      gap:20px; 
      align-items:end; 
    }
    .filter-group { 
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .filter-group label { 
      font-weight:600; 
      margin-bottom:10px; 
      display:block; 
      color: #1e293b;
      font-size: 0.95rem;
    }
    select { 
      padding:14px 18px; 
      border:2px solid #e2e8f0; 
      border-radius:12px; 
      background:white; 
      font-size:15px; 
      width:100%; 
      transition: all 0.3s;
      color: #334155;
    }
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }
    .buttons { 
      display:flex; 
      gap:15px; 
      flex-wrap:wrap; 
      margin-top:20px;
      justify-content: flex-end;
    }
    button { 
      padding:15px 28px; 
      border:none; 
      border-radius:12px; 
      font-weight:600; 
      cursor:pointer; 
      display:flex; 
      align-items:center; 
      gap:12px; 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 16px;
      letter-spacing: 0.3px;
      position: relative;
      overflow: hidden;
    }
    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    button:hover::before {
      width: 300px;
      height: 300px;
    }
    .btn-primary { 
      background: linear-gradient(135deg, var(--primary) 0%, #1e3a8a 100%); 
      color:white;
      box-shadow: 0 6px 20px rgba(30, 64, 175, 0.3);
    }
    .btn-primary:hover { 
      background: linear-gradient(135deg, #1e3a8a 0%, #1e3a8a 100%);
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(30, 64, 175, 0.4);
    }
    .btn-success { 
      background: linear-gradient(135deg, var(--success) 0%, #047857 100%); 
      color:white;
      box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3);
    }
    .btn-success:hover { 
      background: linear-gradient(135deg, #047857 0%, #065f46 100%);
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(5, 150, 105, 0.4);
    }
    .btn-excel { 
      background: linear-gradient(135deg, #217346 0%, #185c37 100%); 
      color:white; 
      box-shadow: 0 6px 20px rgba(33, 115, 70, 0.3);
    }
    .btn-excel:hover { 
      background: linear-gradient(135deg, #185c37 0%, #134e2c 100%);
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(33, 115, 70, 0.4);
    }

    /* NOVO DASHBOARD COM CARDS ATRAVES */
    .dashboard { 
      display:grid; 
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); 
      gap:30px; 
      padding:40px 30px;
    }
    .dashboard-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(226, 232, 240, 0.6);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .dashboard-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, var(--card-color), var(--card-color-dark));
    }
    .dashboard-card:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    .card-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 25px;
    }
    .card-icon {
      width: 70px;
      height: 70px;
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: white;
      background: linear-gradient(135deg, var(--card-color), var(--card-color-dark));
      flex-shrink: 0;
      box-shadow: 0 8px 20px rgba(var(--card-rgb), 0.3);
    }
    .card-title {
      margin: 0;
      color: #1e293b;
      font-size: 1.4rem;
      font-weight: 700;
    }
    .card-subtitle {
      margin: 5px 0 0;
      color: #64748b;
      font-size: 0.95rem;
    }
    .card-value {
      font-size: 3.5rem;
      font-weight: 900;
      color: var(--card-color-dark);
      margin: 15px 0;
      line-height: 1;
      text-align: center;
      background: linear-gradient(135deg, var(--card-color), var(--card-color-dark));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .card-trend {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: #059669;
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid #e2e8f0;
    }
    .card-action {
      margin-top: 20px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: var(--card-color);
      font-weight: 600;
      transition: all 0.3s;
    }
    .card-action:hover {
      background: var(--card-color);
      color: white;
      transform: translateX(5px);
    }

    .modal, .modalPerf, .modalDetalhes { 
      display:none; 
      position:fixed; 
      inset:0; 
      background:rgba(0,0,0,0.75); 
      justify-content:center; 
      align-items:center; 
      z-index:2000; 
      padding:20px; 
      backdrop-filter: blur(5px);
    }
    .modal-content, .modalPerf-content, .modalDetalhes-content { 
      background:white; 
      width:95%; 
      max-width:1500px; 
      max-height:95vh; 
      border-radius:24px; 
      overflow:hidden; 
      box-shadow:0 30px 80px rgba(0,0,0,0.4);
      animation: modalAppear 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    /* CORREÇÃO APLICADA: Tamanho do modal de visualização de PDF */
    #modalPDFViewer .modal-content { 
      max-width: 900px; 
      max-height: 90vh; 
      width: 90%; 
      height: 90%; 
    }
    
    @keyframes modalAppear {
      from {
        opacity: 0;
        transform: translateY(50px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    .modal-header { 
      background: linear-gradient(135deg, var(--primary) 0%, #1e3a8a 100%);
      color:white; 
      padding:25px 35px; 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      font-size:1.6rem; 
      font-weight:600;
    }
    .modal-actions { 
      display: flex; 
      gap: 12px; 
      align-items: center;
    }
    .close { 
      font-size:40px; 
      cursor:pointer; 
      font-weight:300;
      margin-left: 20px;
      transition: transform 0.3s;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    .close:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: rotate(90deg);
    }
    .modal-body { 
      padding:35px; 
      overflow-y:auto; 
      max-height:calc(95vh - 120px); 
    }
    /* CORREÇÃO APLICADA: Garantindo que o body do PDF Viewer tenha 100% do espaço disponível */
    #modalPDFViewer .modal-body { 
      padding: 0; 
      height: calc(100% - 80px); /* Ajustado para 100% da altura do content menos o header */
      max-height: none; 
    }
    #pdfFrame {
      width: 100%; 
      height: 100%; 
      border: none;
    }

    .charts-container { 
      display:grid; 
      grid-template-columns:repeat(auto-fit,minmax(450px,1fr)); 
      gap:30px; 
      margin:30px 0; 
    }
    .chart-card { 
      background:white; 
      padding:25px; 
      border-radius:18px; 
      box-shadow:0 8px 25px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
    }

    .depto-resumo { 
      display:grid; 
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); 
      gap:25px; 
      margin:40px 0; 
    }
    .depto-card { 
      background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-left:6px solid var(--primary); 
      padding:25px; 
      border-radius:16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.05);
    }
    .depto-card h4 { 
      margin:0 0 20px; 
      color:var(--primary); 
      font-size:1.4rem; 
      font-weight: 700;
    }
    .depto-card .stats { 
      display:grid; 
      grid-template-columns:1fr 1fr; 
      gap:15px; 
      font-size:15px; 
    }
    .depto-card .stats div {
      background: white;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
    }
    .depto-card .stats strong { 
      color:#1e3a8a; 
      font-size: 1.3rem;
      display: block;
      margin-bottom: 5px;
    }

    .registros-depto { 
      margin-top:50px; 
      border-top:2px solid #e2e8f0; 
      padding-top:30px; 
    }
    .registros-depto h4 { 
      color:var(--primary); 
      margin-bottom:20px; 
      font-size: 1.5rem;
    }
    table { 
      width:100%; 
      border-collapse:separate; 
      border-spacing:0;
      margin-top:20px; 
      font-size:14px; 
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    th { 
      background: linear-gradient(135deg, var(--primary) 0%, #1e3a8a 100%);
      color:white; 
      padding:18px 15px; 
      text-align:center;
      font-weight: 600;
      border-right: 1px solid rgba(255,255,255,0.1);
    }
    th:last-child {
      border-right: none;
    }
    td { 
      padding:16px 15px; 
      text-align:center; 
      border-bottom:1px solid #e2e8f0;
      background: white;
    }
    tr:hover td { 
      background:#f0f9ff; 
    }
    tr:last-child td {
      border-bottom: none;
    }

    .hidden { 
      display:none !important; 
    }
    .status { 
      text-align:center; 
      padding:20px; 
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color:#065f46; 
      font-weight:600; 
      border-radius:16px; 
      margin:30px; 
      font-size: 1.1rem;
      box-shadow: 0 6px 20px rgba(5, 150, 105, 0.15);
    }
    .error-status { 
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important; 
      color:#991b1b !important; 
      box-shadow: 0 6px 20px rgba(220, 38, 38, 0.15);
    }

    /* Estilos para o modal de detalhes */
    .detalhes-lista {
      display: grid;
      gap: 15px;
      margin: 25px 0;
    }
    .detalhe-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: #f8fafc;
      border-radius: 12px;
      transition: all 0.3s;
    }
    .detalhe-item:hover {
      background: #f1f5f9;
      transform: translateX(5px);
    }
    .detalhe-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
      width: 100%;
    }
    .detalhe-valor {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--primary);
    }
    .detalhe-local {
      color: #64748b;
      font-size: 0.95rem;
    }
    .detalhe-data {
      color: #94a3b8;
      font-size: 0.9rem;
    }
    .detalhe-itens {
      display: flex;
      gap: 15px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .item-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .item-prisao {
      background-color: #fee2e2;
      color: #991b1b;
    }
    .item-arma {
      background-color: #fef3c7;
      color: #92400e;
    }
    .item-municao {
      background-color: #f3e8ff;
      color: #6b21a8;
    }
    .item-droga {
      background-color: #d1fae5;
      color: #065f46;
    }

    /* Estilos para o rodapé */
    .footer {
      text-align: center;
      padding: 30px;
      color: #64748b;
      font-size: 0.9rem;
      border-top: 1px solid #e2e8f0;
      background: #f8fafc;
    }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>OPERAÇÃO BARRICADA ZERO – Dashboard de Resultados</h1>
    <p>Análise avançada de operações realizadas em parceria com a PCERJ</p>
  </header>

  <div id="uploadSection" class="upload-area">
    <i class="fas fa-cloud-upload-alt"></i>
    <h3>Clique para importar o arquivo Excel</h3>
    <p><strong>Operação Barricada Zero.xlsx</strong> (Formatos suportados: .xlsx, .xls)</p>
    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none">
  </div>

  <div id="status" class="status hidden"></div>

  <div id="mainControls" class="hidden">
    <div class="controls">
      <div class="filter-row">
        <div class="filter-group">
          <label><i class="fas fa-building"></i> Departamento</label>
          <select id="filterDepto"><option value="">Todos os Departamentos</option></select>
        </div>
        <div class="filter-group">
          <label><i class="fas fa-shield-alt"></i> Unidade (DP)</label>
          <select id="filterUnid"><option value="">Todas as Unidades</option></select>
        </div>
        <div class="filter-group">
          <label><i class="fas fa-map-marker-alt"></i> Local / Comunidade</label>
          <select id="filterLocal"><option value="">Todos os Locais</option></select>
        </div>
        <div class="filter-group">
          <label><i class="fas fa-users"></i> Facção</label>
          <select id="filterFaccao"><option value="">Todas as Facções</option></select>
        </div>
      </div>
      <div class="buttons">
        <button id="btnAnalise" class="btn-primary">
          <i class="fas fa-chart-line"></i> Análise de Performance
        </button>
        <button id="btnPdf" class="btn-success">
          <i class="fas fa-file-pdf"></i> Gerar PDF Completo
        </button>
      </div>
    </div>

    <div class="dashboard" id="dashboard"></div>
  </div>

  <div class="footer">
    <p>Operação Barricada Zero - Sistema de Inteligência Operacional | Desenvolvido para análise estratégica de Ações</p>
    <p>© GSI - 2025 Todos os direitos reservados</p>
  </div>
</div>

<div id="modalPerf" class="modalPerf">
  <div class="modalPerf-content">
    <div class="modal-header">
      <div><i class="fas fa-chart-bar"></i> Análise de Performance por Departamento</div>
      <div class="modal-actions">
        <button id="btnExportarExcel" class="btn-excel">
          <i class="fas fa-file-excel"></i> Exportar Excel
        </button>
        <button id="btnPdfPerf" class="btn-success">
          <i class="fas fa-file-pdf"></i> Gerar PDF
        </button>
        <span class="close" onclick="fecharModal('modalPerf')">×</span>
      </div>
    </div>
    <div class="modal-body" id="modalPerfBody">
      <div class="charts-container">
        <div class="chart-card"><canvas id="chartPrisoes"></canvas></div>
        <div class="chart-card"><canvas id="chartArmas"></canvas></div>
      </div>
      <div class="charts-container">
        <div class="chart-card"><canvas id="chartOperacoes"></canvas></div>
        <div class="chart-card"><canvas id="chartPizza"></canvas></div>
      </div>

      <h3 style="margin:50px 0 20px; color:var(--primary); text-align:center;">
        <i class="fas fa-building"></i> Resumo por Departamento
      </h3>
      <div class="depto-resumo" id="deptoResumo"></div>

      <h3 style="margin:60px 0 20px; color:var(--primary); text-align:center;">
        <i class="fas fa-list-alt"></i> Registros Detalhados por Departamento
      </h3>
      <div id="registrosDetalhados"></div>
    </div>
  </div>
</div>

<div id="modalDetalhes" class="modalDetalhes">
  <div class="modalDetalhes-content">
    <div class="modal-header">
      <div id="modalDetalhesTitulo"></div>
      <div class="modal-actions">
        <button id="btnPdfDetalhes" class="btn-success">
          <i class="fas fa-file-pdf"></i> PDF Detalhado
        </button>
        <span class="close" onclick="fecharModal('modalDetalhes')">×</span>
      </div>
    </div>
    <div class="modal-body" id="modalDetalhesBody"></div>
  </div>
</div>

<div id="modalPDFViewer" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div id="pdfViewerTitle"><i class="fas fa-file-pdf"></i> Visualização de PDF</div>
      <div class="modal-actions">
        <button id="btnDownloadPDF" class="btn-success">
          <i class="fas fa-download"></i> Baixar PDF
        </button>
        <span class="close" onclick="fecharModal('modalPDFViewer')">×</span>
      </div>
    </div>
    <div class="modal-body">
      <iframe id="pdfFrame" style="width: 100%; height: 100%; border: none;"></iframe>
    </div>
  </div>
</div>

<script>
// Constantes para mapeamento de colunas (Usadas após padronização)
const COLUNA_REGOCOR = 'REGOCOR';
const COLUNA_DTEVENTO = 'DTEVENTO';
const COLUNA_DEPTO = 'DEPTO';
const COLUNA_UNIDDP = 'UNIDDP';
const COLUNA_LOCAL = 'LOCAL';
const COLUNA_FACCAO = 'FACCAO';
const COLUNA_PRISOES = 'PRISOES';
const COLUNA_ARMAS = 'ARMAS';
const COLUNA_MUNICOES = 'MUNICOES';
const COLUNA_DROGAS = 'DROGAS(KG)'; // Mantendo o formato original se for o caso
const COLUNA_RO = 'REG OCOR'; // Usando o nome completo para clareza, o mapeamento padronizado será REGOCOR
const COLUNA_DROGAS_ITENS = 'DROGASITENS'; // Nova coluna para quantidade de itens de drogas

function fecharModal(id) {
    document.getElementById(id).style.display = 'none';
}

// Conversor Excel → DD/MM/AAAA
function converterDataExcel(serial) {
  if (!serial || typeof serial !== 'number' || serial < 1) {
    // Tenta tratar como string de data no formato AAAA-MM-DD
    if (typeof serial === 'string') {
        const partes = serial.split('/');
        if (partes.length === 3) return serial; // Já está no formato DD/MM/AAAA
        // Se for string, retorna a própria string para evitar NaN
        return serial.trim(); 
    }
    return "";
  }
  const dias = Math.floor(serial - 25569);
  const data = new Date(dias * 86400000);
  const d = String(data.getUTCDate()).padStart(2,'0');
  const m = String(data.getUTCMonth()+1).padStart(2,'0');
  const a = data.getUTCFullYear();
  return `${d}/${m}/${a}`;
}

function baixarPDF(dataUri, filename) {
  const link = document.createElement('a');
  link.href = dataUri;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

let dadosOriginais = [];
let charts = {};
let dadosFiltradosAtual = [];
let modalDetalhesTipo = '';
let modalDetalhesDados = [];

// Upload
document.getElementById('uploadSection').onclick = () => document.getElementById('fileInput').click();

document.getElementById('fileInput').onchange = function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type:'array'});

      const sheetName = workbook.SheetNames.find(n => 
        n.toUpperCase().includes('REGISTRO') || 
        n.toUpperCase().includes('DADOS') ||
        n.toUpperCase().includes('OPERAÇÕES')
      );
      if (!sheetName) throw new Error("Aba com dados (Registro/Operações) não encontrada!");

      const worksheet = workbook.Sheets[sheetName];
      // Leitura para JSON, preservando o tipo para datas
      const json = XLSX.utils.sheet_to_json(worksheet, {header:1, defval:""});

      // NOVIDADE: Mapeamento e padronização rigorosa dos cabeçalhos
      // Remove espaços, caracteres especiais e transforma em maiúsculas
      const rawHeaders = json[0] || [];
      const headers = rawHeaders.map(h => 
        String(h).toUpperCase().trim().replace(/[^A-Z0-9]/g, '')
      );
      
      // Mapeamento dos headers originais para os padronizados
      const headerMap = {};
      rawHeaders.forEach((h, i) => {
          if (h && headers[i]) {
              headerMap[headers[i]] = i;
          }
      });
      
      if (headers.length < 5) {
          throw new Error("Formato de planilha inválido. Verifique se o cabeçalho (primeira linha) está correto.");
      }
      
      dadosOriginais = json.slice(1)
        .map(row => {
          let obj = {};
          // Itera sobre os cabeçalhos PADRONIZADOS
          headers.forEach((h, i) => {
            const v = row[i];
            
            // Tratamento específico de datas
            if (h === COLUNA_DTEVENTO.replace(/[^A-Z0-9]/g, '')) {
              obj[h] = converterDataExcel(v);
            } else {
              // Converte para string e remove espaços, exceto para números
              obj[h] = String(v ?? '').trim();
            }
          });
          return obj;
        })
        .filter(r => 
          r[COLUNA_REGOCOR.replace(/[^A-Z0-9]/g, '')] && r[COLUNA_REGOCOR.replace(/[^A-Z0-9]/g, '')].trim() !== ''
        );

      dadosOriginais.sort((a,b) => {
        const formatarData = (dataStr) => {
            const parts = dataStr.split('/');
            return parts.length === 3 ? new Date(`${parts[2]}-${parts[1]}-${parts[0]}`) : new Date(0);
        };
        const da = formatarData(a[COLUNA_DTEVENTO.replace(/[^A-Z0-9]/g, '')]);
        const db = formatarData(b[COLUNA_DTEVENTO.replace(/[^A-Z0-9]/g, '')]);
        return db - da;
      });

      document.getElementById('status').textContent = `✅ Sucesso! ${dadosOriginais.length} registros importados`;
      document.getElementById('status').classList.remove('hidden','error-status');
      document.getElementById('uploadSection').classList.add('hidden');
      document.getElementById('mainControls').classList.remove('hidden');

      popularFiltros();
      aplicarFiltros();

    } catch (err) {
      document.getElementById('status').textContent = `❌ Erro de Importação: ${err.message}. Verifique o nome da aba e o cabeçalho da planilha.`;
      document.getElementById('status').classList.add('error-status');
      document.getElementById('status').classList.remove('hidden');
      console.error('Erro no processamento:', err);
    }
  };
  reader.readAsArrayBuffer(file);
};

function popularFiltros() {
  const mapField = (original) => original.toUpperCase().trim().replace(/[^A-Z0-9]/g, '');

  const unique = campoPadronizado => {
    const valores = dadosOriginais
      .map(r => r[campoPadronizado])
      .filter(v => v && String(v).trim() !== '')
      .map(v => String(v).trim());
    return [...new Set(valores)].sort();
  };

  const popular = (id, valores, labelTodos) => {
    const select = document.getElementById(id);
    select.innerHTML = `<option value="">${labelTodos}</option>`;
    valores.forEach(v => select.add(new Option(v, v)));
  };

  popular('filterDepto', unique(mapField('DEPTO')), 'Todos os Departamentos');
  popular('filterUnid', unique(mapField('UNID (DP)')), 'Todas as Unidades');
  popular('filterLocal', unique(mapField('LOCAL')), 'Todos os Locais');
  popular('filterFaccao', unique(mapField('FACÇÃO')), 'Todas as Facções');
  
  document.querySelectorAll('select').forEach(s => s.onchange = aplicarFiltros);
}

function getDadosFiltrados() {
  const mapField = (original) => original.toUpperCase().trim().replace(/[^A-Z0-9]/g, '');
  
  let dados = [...dadosOriginais];

  // FILTRO PRINCIPAL: Incluir apenas registros que contenham ao menos um item/produto vinculado
  dados = dados.filter(r => 
    (r[mapField('PRISÕES')] || '').trim() !== '' ||
    (r[mapField('ARMAS')] || '').trim() !== '' ||
    (r[mapField('MUNIÇÕES')] || '').trim() !== '' ||
    (r[mapField('DROGAS (KG)')] || 0) > 0
  );
  
  const filtros = [
    {id: 'Depto', campo: mapField('DEPTO')},
    {id: 'Unid', campo: mapField('UNID (DP)')},
    {id: 'Local', campo: mapField('LOCAL')},
    {id: 'Faccao', campo: mapField('FACÇÃO')}
  ];

  filtros.forEach(filtro => {
    const valor = document.getElementById('filter' + filtro.id).value;
    if (valor && valor !== '') {
      dados = dados.filter(r => 
        r[filtro.campo] && String(r[filtro.campo]).trim() === valor
      );
    }
  });

  return dados;
}

function aplicarFiltros() { 
  dadosFiltradosAtual = getDadosFiltrados();
  mostrarDashboard(dadosFiltradosAtual); 
}

function mostrarDashboard(dados) {
  const mapField = (original) => original.toUpperCase().trim().replace(/[^A-Z0-9]/g, '');
  const dashboard = document.getElementById('dashboard');
  dashboard.innerHTML = '';
  
  const totalRegistros = dados.length || 0;
  // Cálculo do total de R.O.'s únicos
  const totalROsUnicos = new Set(dados.map(r => r[mapField(COLUNA_REGOCOR)]).filter(Boolean)).size || 0;
  const totalPrisoes = dados.reduce((a, r) => a + ((r[mapField('PRISÕES')] || '').trim() !== '' ? 1 : 0), 0) || 0;
  const totalArmas = dados.reduce((a, r) => a + ((r[mapField('ARMAS')] || '').trim() !== '' ? 1 : 0), 0) || 0;
  const totalMunicoes = dados.reduce((a, r) => a + ((r[mapField('MUNIÇÕES')] || '').trim() !== '' ? 1 : 0), 0) || 0;
  
  // CORREÇÃO: Contabiliza quantidade de itens de drogas (linhas com drogas)
  const totalDrogasItens = dados.reduce((a, r) => {
    const drogasValue = r[mapField('DROGAS (KG)')];
    if (drogasValue && drogasValue !== '' && parseFloat(drogasValue) > 0) {
      return a + 1;
    }
    return a;
  }, 0) || 0;
  
  // Total de kg de drogas (mantido para referência)
  const totalDrogasKg = dados.reduce((a, r) => a + parseFloat(r[mapField('DROGAS (KG)')] || 0), 0) || 0;
  const locaisUnicos = new Set(dados.map(r => r[mapField('LOCAL')]).filter(Boolean)).size || 0;
  
  const cards = [
    { id: 'ros', titulo: 'R.O.s Únicos', subtitulo: 'Total de Registros de Ocorrência', valor: totalROsUnicos, icone: 'fa-clipboard-list', cor: '#3b82f6', corEscura: '#1e3a8a' },
    { id: 'registros', titulo: 'Entradas', subtitulo: 'Total de Linhas (Itens)', valor: totalRegistros, icone: 'fa-list-ol', cor: '#5a67d8', corEscura: '#434190' },
    { id: 'prisoes', titulo: 'Prisões', subtitulo: 'Total de Prisões', valor: totalPrisoes, icone: 'fa-handcuffs', cor: '#dc2626', corEscura: '#991b1b' },
    { id: 'armas', titulo: 'Armas', subtitulo: 'Armas Apreendidas', valor: totalArmas, icone: 'fa-gun', cor: '#f59e0b', corEscura: '#d97706' },
    { id: 'municoes', titulo: 'Munições', subtitulo: 'Munições Apreendidas', valor: totalMunicoes, icone: 'fa-bullseye', cor: '#8b5cf6', corEscura: '#7c3aed' },
    // CORREÇÃO: Card de Drogas agora mostra quantidade de itens de drogas
    { id: 'drogas', titulo: 'Drogas', subtitulo: 'Itens com Droga Apreendida', valor: totalDrogasItens, icone: 'fa-capsules', cor: '#059669', corEscura: '#047857' },
    { id: 'locais', titulo: 'Locais', subtitulo: 'Locais Atuados (Com Itens)', valor: locaisUnicos, icone: 'fa-map-marker-alt', cor: '#06b6d4', corEscura: '#0891b2' }
  ];

  cards.forEach(card => {
    const cardElement = document.createElement('div');
    cardElement.className = 'dashboard-card';
    cardElement.style.setProperty('--card-color', card.cor);
    cardElement.style.setProperty('--card-color-dark', card.corEscura);
    cardElement.style.setProperty('--card-rgb', parseInt(card.cor.slice(1,3), 16) + ',' + parseInt(card.cor.slice(3,5), 16) + ',' + parseInt(card.cor.slice(5,7), 16));

    cardElement.innerHTML = `
      <div class="card-header"><div class="card-icon"><i class="fas ${card.icone}"></i></div>
        <div><h3 class="card-title">${card.titulo}</h3><p class="card-subtitle">${card.subtitulo}</p></div>
      </div>
      <div class="card-value">${card.valor}</div>
      <div class="card-action" onclick="mostrarDetalhes('${card.id}', '${card.titulo}')"><i class="fas fa-search"></i> Detalhes</div>
    `;
    dashboard.appendChild(cardElement);
  });
}

function mostrarDetalhes(tipo, titulo) {
  const mapField = (original) => original.toUpperCase().trim().replace(/[^A-Z0-9]/g, '');
  modalDetalhesTipo = tipo;
  const modalBody = document.getElementById('modalDetalhesBody');
  document.getElementById('modalDetalhesTitulo').innerHTML = `<i class="fas fa-search"></i> ${titulo}`;

  if (tipo === 'locais') {
    const locaisAgrupados = {};
    dadosFiltradosAtual.forEach(r => {
      const local = r[mapField('LOCAL')];
      if (local) {
        if (!locaisAgrupados[local]) locaisAgrupados[local] = { count: 0, prisoes: 0, armas: 0, municoes: 0, drogas: 0 };
        locaisAgrupados[local].count++;
        locaisAgrupados[local].prisoes += (r[mapField('PRISÕES')] || '').trim() !== '' ? 1 : 0;
        locaisAgrupados[local].armas += (r[mapField('ARMAS')] || '').trim() !== '' ? 1 : 0;
        locaisAgrupados[local].municoes += (r[mapField('MUNIÇÕES')] || '').trim() !== '' ? 1 : 0;
        locaisAgrupados[local].drogas += parseFloat(r[mapField('DROGAS (KG)')] || 0) > 0 ? 1 : 0;
      }
    });
    modalDetalhesDados = Object.entries(locaisAgrupados).map(([local, info]) => ({ local, ...info }));
    modalBody.innerHTML = `<div class="detalhes-lista">${modalDetalhesDados.sort((a,b)=>b.count-a.count).map(i => `
      <div class="detalhe-item"><div class="detalhe-info"><span class="detalhe-valor">${i.local}</span>
      <div style="display:flex; gap:15px; font-size:0.9rem;">
        <span style="color:#dc2626">Prisões: ${i.prisoes}</span> 
        <span style="color:#f59e0b">Armas: ${i.armas}</span> 
        <span style="color:#8b5cf6">Munições: ${i.municoes}</span>
        <span style="color:#059669">Drogas: ${i.drogas}</span>
        <span style="color:#3b82f6">Entradas: ${i.count}</span>
      </div></div></div>`).join('')}</div>`;
  } else if (tipo === 'ros') {
    // Agrupa por R.O. e mostra itens vinculados
    const rosAgrupados = {};
    dadosFiltradosAtual.forEach(r => {
      const ro = r[mapField(COLUNA_REGOCOR)];
      if (ro) {
        if (!rosAgrupados[ro]) {
          rosAgrupados[ro] = {
            data: r[mapField('DT EVENTO')],
            depto: r[mapField('DEPTO')],
            unidade: r[mapField('UNID (DP)')],
            local: r[mapField('LOCAL')],
            prisoes: [],
            armas: [],
            municoes: [],
            drogas: []
          };
        }
        
        // Adiciona itens se existirem
        if ((r[mapField('PRISÕES')] || '').trim() !== '') {
          rosAgrupados[ro].prisoes.push(r[mapField('PRISÕES')]);
        }
        if ((r[mapField('ARMAS')] || '').trim() !== '') {
          rosAgrupados[ro].armas.push(r[mapField('ARMAS')]);
        }
        if ((r[mapField('MUNIÇÕES')] || '').trim() !== '') {
          rosAgrupados[ro].municoes.push(r[mapField('MUNIÇÕES')]);
        }
        if (parseFloat(r[mapField('DROGAS (KG)')] || 0) > 0) {
          rosAgrupados[ro].drogas.push(parseFloat(r[mapField('DROGAS (KG)')]));
        }
      }
    });

    modalDetalhesDados = Object.entries(rosAgrupados).map(([ro, info]) => ({ ro, ...info }));
    modalBody.innerHTML = `<div class="detalhes-lista">${modalDetalhesDados.map(i => `
      <div class="detalhe-item">
        <div class="detalhe-info">
          <span class="detalhe-valor" style="font-size:1.2rem; color: #1e3a8a">R.O.: ${i.ro}</span>
          <span class="detalhe-local">${i.local} - ${i.unidade} (${i.depto})</span>
          <span class="detalhe-data">${i.data}</span>
          <div class="detalhe-itens">
            ${i.prisoes.length > 0 ? `<span class="item-badge item-prisao">Prisões: ${i.prisoes.length}</span>` : ''}
            ${i.armas.length > 0 ? `<span class="item-badge item-arma">Armas: ${i.armas.length}</span>` : ''}
            ${i.municoes.length > 0 ? `<span class="item-badge item-municao">Munições: ${i.municoes.length}</span>` : ''}
            ${i.drogas.length > 0 ? `<span class="item-badge item-droga">Drogas: ${i.drogas.length} itens (${i.drogas.reduce((a,b)=>a+b,0).toFixed(2)} kg)</span>` : ''}
          </div>
        </div>
      </div>`).join('')}</div>`;
  } else if (tipo === 'drogas') {
    // CORREÇÃO: Filtra apenas registros que têm drogas e exibe a lista
    modalDetalhesDados = dadosFiltradosAtual.filter(r => 
      parseFloat(r[mapField('DROGAS (KG)')] || 0) > 0
    );

    modalBody.innerHTML = `<div class="detalhes-lista">${modalDetalhesDados.slice(0, 100).map(r => `
      <div class="detalhe-item">
        <div class="detalhe-info">
          <span class="detalhe-valor" style="font-size:1.2rem; color: #1e3a8a">
            ${r[mapField('DROGAS (KG)')]} kg
          </span>
          <span class="detalhe-local">${r[mapField('LOCAL')]} - ${r[mapField('UNID (DP)')]}</span>
          <span class="detalhe-data">${r[mapField('DT EVENTO')]} | RO: ${r[mapField('REG OCOR')]}</span>
          <div class="detalhe-itens">
            ${(r[mapField('PRISÕES')] || '').trim() !== '' ? `<span class="item-badge item-prisao">Prisão</span>` : ''}
            ${(r[mapField('ARMAS')] || '').trim() !== '' ? `<span class="item-badge item-arma">Arma</span>` : ''}
            ${(r[mapField('MUNIÇÕES')] || '').trim() !== '' ? `<span class="item-badge item-municao">Munição</span>` : ''}
            <span class="item-badge item-droga">Droga: ${r[mapField('DROGAS (KG)')]} kg</span>
          </div>
        </div>
      </div>`).join('')}</div>`;
  } else {
    // Filtragem rigorosa: remove registros onde o dado da categoria está vazio
    const campoMapping = { 
      'prisoes': mapField('PRISÕES'), 
      'armas': mapField('ARMAS'), 
      'municoes': mapField('MUNIÇÕES'), 
      'registros': mapField('REG OCOR') 
    };
    
    modalDetalhesDados = (tipo === 'registros') 
        ? dadosFiltradosAtual 
        : dadosFiltradosAtual.filter(r => (r[campoMapping[tipo]] || '').trim() !== '');

    modalBody.innerHTML = `<div class="detalhes-lista">${modalDetalhesDados.slice(0, 100).map(r => `
      <div class="detalhe-item">
        <div class="detalhe-info">
          <span class="detalhe-valor" style="font-size:1.2rem; color: #1e3a8a">
            ${tipo === 'registros' ? 'RO: ' + r[mapField('REG OCOR')] : r[campoMapping[tipo]]}
          </span>
          <span class="detalhe-local">${r[mapField('LOCAL')]} - ${r[mapField('UNID (DP)')]}</span>
          <span class="detalhe-data">${r[mapField('DT EVENTO')]}</span>
          <div class="detalhe-itens">
            ${(r[mapField('PRISÕES')] || '').trim() !== '' ? `<span class="item-badge item-prisao">Prisão</span>` : ''}
            ${(r[mapField('ARMAS')] || '').trim() !== '' ? `<span class="item-badge item-arma">Arma</span>` : ''}
            ${(r[mapField('MUNIÇÕES')] || '').trim() !== '' ? `<span class="item-badge item-municao">Munição</span>` : ''}
            ${parseFloat(r[mapField('DROGAS (KG)')] || 0) > 0 ? `<span class="item-badge item-droga">Droga: ${r[mapField('DROGAS (KG)')]} kg</span>` : ''}
          </div>
        </div>
      </div>`).join('')}</div>`;
  }
  
  // Se não houver dados, mostra mensagem
  if (modalDetalhesDados.length === 0) {
    modalBody.innerHTML = `<div style="text-align: center; padding: 50px; color: #64748b;">
      <i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 20px;"></i>
      <h3>Nenhum dado encontrado</h3>
      <p>Não há registros para exibir nesta categoria com os filtros atuais.</p>
    </div>`;
  }
  
  document.getElementById('modalDetalhes').style.display = 'flex';
}

function getPdfHeader(doc, title, isLandscape = false) {
  const width = isLandscape ? 297 : 210;
  doc.setFillColor(30, 64, 175);
  doc.rect(0, 0, width, 40, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(20);
  doc.setFont(undefined, 'bold');
  doc.text(title, width/2, 18, {align:"center"});
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text(`Operação Barricada Zero - Sistema de Inteligência Operacional | Gerado em: ${new Date().toLocaleString()}`, width/2, 28, {align:"center"});
}

document.getElementById('btnPdfDetalhes').onclick = function() {
  const mapField = (original) => original.toUpperCase().trim().replace(/[^A-Z0-9]/g, '');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"portrait",unit:"mm",format:"a4"});
  const cardInfo = {
    'registros': { titulo: 'REGISTROS', cor: [59, 130, 246] },
    'prisoes': { titulo: 'PRISÕES', cor: [220, 38, 38] },
    'armas': { titulo: 'ARMAS', cor: [245, 158, 11] },
    'municoes': { titulo: 'MUNIÇÕES', cor: [139, 92, 246] },
    'drogas': { titulo: 'DROGAS', cor: [5, 150, 105] },
    'locais': { titulo: 'LOCAIS', cor: [6, 182, 212] },
    'ros': { titulo: 'R.O.s ÚNICOS', cor: [59, 130, 246] }
  }[modalDetalhesTipo] || { titulo: 'DETALHES', cor: [59, 130, 246] };

  getPdfHeader(doc, `DETALHES: ${cardInfo.titulo}`);
  
  doc.setFillColor(cardInfo.cor[0], cardInfo.cor[1], cardInfo.cor[2]);
  doc.roundedRect(20, 50, 170, 30, 3, 3, 'F');
  doc.setFillColor(255, 255, 255, 0.2);
  doc.circle(35, 65, 8, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(18);
  doc.text(cardInfo.titulo, 50, 66);
  doc.text(String(modalDetalhesDados.length), 180, 66, {align:"right"});

  let tableData = [];
  let headers = [];
  
  if (modalDetalhesTipo === 'locais') {
    headers = ['Local', 'Total Entradas', 'Prisões', 'Armas', 'Munições', 'Drogas'];
    tableData = modalDetalhesDados.map(i => [i.local, i.count, i.prisoes, i.armas, i.municoes, i.drogas]);
  } else if (modalDetalhesTipo === 'ros') {
    headers = ['R.O.', 'Data', 'Unidade', 'Local', 'Prisões', 'Armas', 'Munições', 'Drogas (kg)'];
    tableData = modalDetalhesDados.map(i => [
      i.ro, 
      i.data, 
      i.unidade, 
      i.local,
      i.prisoes.length,
      i.armas.length,
      i.municoes.length,
      i.drogas.reduce((a,b)=>a+b,0).toFixed(2)
    ]);
  } else if (modalDetalhesTipo === 'drogas') {
    headers = ['RO', 'Data', 'Unidade', 'Local', 'Drogas (kg)', 'Prisões', 'Armas', 'Munições'];
    tableData = modalDetalhesDados.map(r => [
      r[mapField('REG OCOR')], 
      r[mapField('DT EVENTO')], 
      r[mapField('UNID (DP)')], 
      r[mapField('LOCAL')], 
      r[mapField('DROGAS (KG)')] || '0',
      r[mapField('PRISÕES')] || '0',
      r[mapField('ARMAS')] || '0',
      r[mapField('MUNIÇÕES')] || '0'
    ]);
  } else {
    const campoMapping = { 'prisoes': mapField('PRISÕES'), 'armas': mapField('ARMAS'), 'municoes': mapField('MUNIÇÕES') };
    headers = ['RO', 'Data', 'Unidade', 'Local', 'Conteúdo'];
    tableData = modalDetalhesDados.map(r => [
      r[mapField('REG OCOR')], 
      r[mapField('DT EVENTO')], 
      r[mapField('UNID (DP)')], 
      r[mapField('LOCAL')], 
      (modalDetalhesTipo === 'registros' ? 'OK' : r[campoMapping[modalDetalhesTipo]])
    ]);
  }

  doc.autoTable({
    startY: 90,
    head: [headers],
    body: tableData.slice(0, 50),
    theme: 'grid',
    headStyles: {fillColor: cardInfo.cor},
    styles: {fontSize: 8},
    margin: { left: 10, right: 10 }
  });

  const pdfDataUri = doc.output('datauristring');
  document.getElementById('pdfFrame').src = pdfDataUri;
  document.getElementById('pdfViewerTitle').innerHTML = '<i class="fas fa-file-pdf"></i> Detalhes - PDF';
  document.getElementById('btnDownloadPDF').setAttribute('onclick', `baixarPDF('${pdfDataUri}', 'Barricada_Zero_Detalhes.pdf')`);
  document.getElementById('modalPDFViewer').style.display = 'flex';
  
  fecharModal('modalDetalhes');
};

// PDF COMPLETO - CORRIGIDO (Melhor distribuição das colunas)
document.getElementById('btnPdf').onclick = () => {
  const mapField = (original) => original.toUpperCase().trim().replace(/[^A-Z0-9]/g, '');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"landscape",unit:"mm",format:"a4"});
  const dados = getDadosFiltrados();
  getPdfHeader(doc, "RELATÓRIO COMPLETO OPERAÇÃO BARRICADA ZERO", true);

  // Cálculo do total de R.O.'s únicos para o PDF Completo
  const totalROsUnicos = new Set(dados.map(r => r[mapField(COLUNA_REGOCOR)]).filter(Boolean)).size;

  // CORREÇÃO: Contabiliza quantidade de itens de drogas
  const totalDrogasItens = dados.reduce((a, r) => {
    const drogasValue = r[mapField('DROGAS (KG)')];
    if (drogasValue && drogasValue !== '' && parseFloat(drogasValue) > 0) {
      return a + 1;
    }
    return a;
  }, 0);

  // Ajuste nas métricas - melhor distribuição horizontal
  const metrics = [
    {t: "R.O.s Únicos", v: totalROsUnicos, c: {r:59, g:130, b:246}},
    {t: "Entradas", v: dados.length, c: {r:90, g:103, b:216}},
    {t: "Prisões", v: dados.reduce((a,r)=>a+((r[mapField('PRISÕES')] || '').trim() !== ''?1:0),0), c: {r:220, g:38, b:38}},
    {t: "Armas", v: dados.reduce((a,r)=>a+((r[mapField('ARMAS')] || '').trim() !== ''?1:0),0), c: {r:245, g:158, b:11}},
    {t: "Drogas (Itens)", v: totalDrogasItens, c: {r:5, g:150, b:105}},
    {t: "Locais", v: new Set(dados.map(r=>r[mapField('LOCAL')]).filter(Boolean)).size, c: {r:6, g:182, b:212}}
  ];

  // Distribuição otimizada dos cards métricos
  const cardWidth = 45;
  const cardGap = 2;
  const startX = 5;
  
  metrics.forEach((m, i) => {
    const x = startX + (i * (cardWidth + cardGap));
    
    // Verifica se o card cabe na página (297mm de largura em landscape)
    if (x + cardWidth < 292) {
      doc.setFillColor(m.c.r, m.c.g, m.c.b);
      doc.roundedRect(x, 50, cardWidth, 25, 3, 3, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(7);
      // Quebra de texto para títulos longos
      const titleLines = doc.splitTextToSize(m.t.toUpperCase(), cardWidth - 4);
      doc.text(titleLines, x + 2, 57);
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text(String(m.v), x + 2, 68);
    }
  });

  // CORREÇÃO PRINCIPAL: Ajuste das larguras das colunas para melhor distribuição
  doc.autoTable({
    startY: 85,
    head: [['RO', 'DATA', 'DEPTO', 'UNID', 'LOCAL', 'PRISÕES', 'ARMAS', 'MUNIÇÕES', 'DROGAS (KG)']],
    body: dados.map(r => [
      r[mapField('REG OCOR')] || '', 
      r[mapField('DT EVENTO')] || '', 
      r[mapField('DEPTO')] || '', 
      r[mapField('UNID (DP)')] || '', 
      r[mapField('LOCAL')] || '', 
      r[mapField('PRISÕES')] || '0', 
      r[mapField('ARMAS')] || '0', 
      r[mapField('MUNIÇÕES')] || '0',
      r[mapField('DROGAS (KG)')] || '0'
    ]),
    theme: 'striped',
    headStyles: {fillColor: [30, 64, 175], fontSize: 7, cellPadding: 2},
    styles: {fontSize: 6, cellPadding: 2, overflow: 'linebreak'},
    columnStyles: {
      // Distribuição otimizada das colunas (total: 287mm)
      0: {cellWidth: 25},  // RO
      1: {cellWidth: 20},  // DATA
      2: {cellWidth: 25},  // DEPTO
      3: {cellWidth: 30},  // UNID
      4: {cellWidth: 45},  // LOCAL (maior para nomes longos)
      5: {cellWidth: 45},  // PRISÕES (maior para nomes)
      6: {cellWidth: 35},  // ARMAS
      7: {cellWidth: 25},  // MUNIÇÕES
      8: {cellWidth: 37}   // DROGAS (KG)
    },
    margin: { left: 5, right: 5 },
    tableWidth: 287,
    pageBreak: 'auto',
    didDrawPage: function(data) {
      // Adiciona número da página
      doc.setFontSize(8);
      doc.setTextColor(100);
      doc.text(
        `Página ${data.pageNumber}`, 
        data.settings.margin.left, 
        doc.internal.pageSize.height - 10
      );
    }
  });

  const pdfDataUri = doc.output('datauristring');
  document.getElementById('pdfFrame').src = pdfDataUri;
  document.getElementById('pdfViewerTitle').innerHTML = '<i class="fas fa-file-pdf"></i> Relatório Completo - PDF';
  document.getElementById('btnDownloadPDF').setAttribute('onclick', `baixarPDF('${pdfDataUri}', 'Barricada_Zero_Relatorio_Completo.pdf')`);
  document.getElementById('modalPDFViewer').style.display = 'flex';
};

// IMPLEMENTAÇÃO DA GERAÇÃO DE PDF NO MODAL DE PERFORMANCE
document.getElementById('btnPdfPerf').onclick = function() {
  const mapField = (original) => original.toUpperCase().trim().replace(/[^A-Z0-9]/g, '');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"landscape",unit:"mm",format:"a4"}); 
  const width = 297; 
  const margin = 10;
  let y = 45;

  // 1. Recálculo dos dados de performance (porDepto) - CORRIGIDO
  const dados = dadosFiltradosAtual;
  const porDepto = {};
  const operacoesPorDepto = {};
  
  dados.forEach(r => {
    const d = r[mapField('DEPTO')] || 'N/I';
    const regocor = r[mapField('REG OCOR')] || '';
    
    if(!operacoesPorDepto[d]) {
      operacoesPorDepto[d] = new Set();
    }
    if(regocor) {
      operacoesPorDepto[d].add(regocor);
    }
    
    if(!porDepto[d]) porDepto[d] = {ops:0, pris:0, arm:0, mun:0, drogItens:0, regs:[]};
    porDepto[d].pris += (r[mapField('PRISÕES')] || '').trim() !== '' ? 1 : 0;
    porDepto[d].arm += (r[mapField('ARMAS')] || '').trim() !== '' ? 1 : 0;
    porDepto[d].mun += (r[mapField('MUNIÇÕES')] || '').trim() !== '' ? 1 : 0;
    
    // CORREÇÃO: Contabiliza itens de drogas
    const drogasValue = r[mapField('DROGAS (KG)')];
    if (drogasValue && drogasValue !== '' && parseFloat(drogasValue) > 0) {
      porDepto[d].drogItens += 1;
    }
    
    porDepto[d].regs.push(r);
  });
  
  // Define a contagem de operações baseada em REG OCOR únicos
  Object.keys(porDepto).forEach(d => {
    porDepto[d].ops = operacoesPorDepto[d] ? operacoesPorDepto[d].size : 0;
  });
  const deptosData = Object.entries(porDepto).map(([d, i]) => ({
    depto: d,
    ops: i.ops,
    pris: i.pris,
    arm: i.arm,
    mun: i.mun,
    drogItens: i.drogItens,
    eficiencia: (i.ops > 0) ? ((i.pris + i.arm + i.mun + i.drogItens) / i.ops).toFixed(2) : '0.00',
    regs: i.regs
  }));
  
  // 2. Adicionar Cabeçalho 
  getPdfHeader(doc, "ANÁLISE DE PERFORMANCE POR DEPARTAMENTO", true);

  // 3. Adicionar Métricas Chave (Cards) com margens ajustadas
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text("Métricas Chave da Performance", margin, y);
  y += 5;

  const totalPrisoes = deptosData.reduce((a, d) => a + d.pris, 0) || 0;
  const totalArmas = deptosData.reduce((a, d) => a + d.arm, 0) || 0;
  const totalOps = deptosData.reduce((a, d) => a + d.ops, 0) || 0;
  const totalRegs = dados.length || 0;
  const totalDrogasItens = deptosData.reduce((a, d) => a + d.drogItens, 0) || 0;

  const metrics = [
    {t: "Total R.O.s Únicos", v: totalOps, c: [59, 130, 246]},
    {t: "Total Prisões", v: totalPrisoes, c: [220, 38, 38]},
    {t: "Total Armas", v: totalArmas, c: [245, 158, 11]},
    {t: "Total Drogas (Itens)", v: totalDrogasItens, c: [5, 150, 105]},
    {t: "Total Entradas", v: totalRegs, c: [6, 182, 212]}
  ];

  // Ajusta posição dos cards para caber na página
  metrics.forEach((m, i) => {
    const cardWidth = 55;
    const x = margin + (i * (cardWidth + 5));
    if (x + cardWidth < width - margin) {
      doc.setFillColor(m.c[0], m.c[1], m.c[2]);
      doc.roundedRect(x, y, cardWidth, 20, 2, 2, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(9);
      doc.setFont(undefined, 'normal');
      doc.text(m.t.toUpperCase(), x + 3, y + 8, {maxWidth: cardWidth - 6});
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.text(String(m.v), x + 3, y + 16);
    }
  });
  y += 30;

  // 4. Tabela de Resumo por Departamento com margens ajustadas
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text("Resumo por Departamento (R.O.s Únicos)", margin, y);
  y += 5;

  const summaryData = deptosData.map(d => [
    d.depto, d.ops, d.pris, d.arm, d.mun, d.drogItens, d.eficiencia
  ]);

  doc.autoTable({
    startY: y,
    head: [['Departamento', 'R.O.s Únicos', 'Prisões', 'Armas', 'Munições', 'Drogas (Itens)', 'Eficiência']],
    body: summaryData,
    theme: 'grid',
    headStyles: {fillColor: [30, 64, 175]},
    styles: {fontSize: 8},
    margin: { left: margin, right: margin },
    tableWidth: width - (2 * margin),
    pageBreak: 'auto'
  });
  y = doc.autoTable.previous.finalY + 15;

  // 5. Tabela de Registros Detalhados com margens ajustadas
  if (y > 170) {
    doc.addPage();
    y = 20;
  }
  
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text("Registros Detalhados (Entradas)", margin, y);
  y += 5;

  const tableRecords = dados.map(r => [
    r[mapField('REG OCOR')], 
    r[mapField('DT EVENTO')], 
    r[mapField('DEPTO')], 
    r[mapField('UNID (DP)')], 
    r[mapField('LOCAL')], 
    r[mapField('FACÇÃO')], 
    r[mapField('PRISÕES')] || '0', 
    r[mapField('ARMAS')] || '0',
    r[mapField('DROGAS (KG)')] || '0'
  ]);

  doc.autoTable({
    startY: y,
    head: [['RO', 'Data', 'Depto', 'Unidade', 'Local', 'Facção', 'Prisões', 'Armas', 'Drogas (Kg)']],
    body: tableRecords,
    theme: 'striped',
    headStyles: {fillColor: [5, 150, 105]},
    styles: {fontSize: 7},
    margin: { left: margin, right: margin },
    tableWidth: width - (2 * margin),
    pageBreak: 'auto'
  });

  // 7. Exibir o PDF
  const pdfDataUri = doc.output('datauristring');
  
  document.getElementById('pdfFrame').src = pdfDataUri;
  document.getElementById('pdfViewerTitle').innerHTML = '<i class="fas fa-file-pdf"></i> Análise de Performance - PDF';
  document.getElementById('btnDownloadPDF').setAttribute('onclick', `baixarPDF('${pdfDataUri}', 'Barricada_Zero_Performance.pdf')`);
  
  fecharModal('modalPerf'); 
  document.getElementById('modalPDFViewer').style.display = 'flex';
};


// PERFORMANCE (CORRIGIDO - Contagem precisa por departamento)
document.getElementById('btnAnalise').onclick = () => {
  const mapField = (original) => original.toUpperCase().trim().replace(/[^A-Z0-9]/g, '');
  const dados = getDadosFiltrados();
  dadosFiltradosAtual = dados;
  const porDepto = {};
  
  // CORREÇÃO: Agrupar por REG OCOR único para contar operações distintas
  const operacoesPorDepto = {};
  
  dados.forEach(r => {
    const d = r[mapField('DEPTO')] || 'N/I';
    const regocor = r[mapField('REG OCOR')] || '';
    
    if(!operacoesPorDepto[d]) {
      operacoesPorDepto[d] = new Set();
    }
    
    // Adiciona o REG OCOR ao conjunto (evita duplicatas)
    if(regocor) {
      operacoesPorDepto[d].add(regocor);
    }
    
    // Acumula dados de produtos
    if(!porDepto[d]) {
      porDepto[d] = {ops:0, pris:0, arm:0, mun:0, drogItens:0, regs:[]};
    }
    
    porDepto[d].pris += (r[mapField('PRISÕES')] || '').trim() !== '' ? 1 : 0;
    porDepto[d].arm += (r[mapField('ARMAS')] || '').trim() !== '' ? 1 : 0;
    porDepto[d].mun += (r[mapField('MUNIÇÕES')] || '').trim() !== '' ? 1 : 0;
    
    // CORREÇÃO: Contabiliza itens de drogas
    const drogasValue = r[mapField('DROGAS (KG)')];
    if (drogasValue && drogasValue !== '' && parseFloat(drogasValue) > 0) {
      porDepto[d].drogItens += 1;
    }
    
    porDepto[d].regs.push(r);
  });
  
  // Define a contagem de operações baseada em REG OCOR únicos
  Object.keys(porDepto).forEach(d => {
    porDepto[d].ops = operacoesPorDepto[d] ? operacoesPorDepto[d].size : 0;
  });

  const labels = Object.keys(porDepto);
  Object.values(charts).forEach(ch => ch?.destroy());

  const config = (ctx, label, data, color) => new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label, data, backgroundColor: color }] },
    options: { plugins: { legend: { display: false }, title: { display: true, text: label } } }
  });

  charts.p = config(document.getElementById('chartPrisoes'), 'Prisões', labels.map(l=>porDepto[l].pris || 0), '#dc2626');
  charts.a = config(document.getElementById('chartArmas'), 'Armas', labels.map(l=>porDepto[l].arm || 0), '#f59e0b');
  charts.o = config(document.getElementById('chartOperacoes'), 'R.O.s Únicos', labels.map(l=>porDepto[l].ops || 0), '#3b82f6');
  charts.z = new Chart(document.getElementById('chartPizza'), { 
    type: 'pie', 
    data: { 
      labels, 
      datasets: [{ 
        label: 'R.O.s Únicos', 
        data: labels.map(l=>porDepto[l].ops || 0), 
        backgroundColor: ['#3b82f6', '#dc2626', '#f59e0b', '#8b5cf6', '#059669', '#06b6d4', '#eab308', '#f43f5e', '#a855f7', '#14b8a6', '#f97316', '#6366f1'] 
      }] 
    },
    options: {
      plugins: {
        title: { display: true, text: 'Distribuição de R.O.s Únicos' }
      }
    }
  });

  const resumoDiv = document.getElementById('deptoResumo');
  resumoDiv.innerHTML = Object.entries(porDepto).map(([d, i]) => `
    <div class="depto-card"><h4>${d}</h4><div class="stats">
      <div><strong>${i.ops || 0}</strong> R.O.s Únicos</div><div><strong>${i.pris || 0}</strong> Prisões</div>
      <div><strong>${i.arm || 0}</strong> Armas</div><div><strong>${i.drogItens || 0}</strong> Drogas (Itens)</div>
      <div><strong>${((i.pris+i.arm+i.mun+i.drogItens)/i.ops || 0).toFixed(2)}</strong> Eficiência</div>
    </div></div>`).join('');

  document.getElementById('modalPerf').style.display = 'flex';
};

document.getElementById('btnExportarExcel').onclick = () => {
  const ws = XLSX.utils.json_to_sheet(dadosFiltradosAtual);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Relatório");
  XLSX.writeFile(wb, "Operação Barricada Zero - Relatorio.xlsx");
};

// Listener para fechar modais ao clicar no fundo
window.onclick = e => { 
  if (e.target.classList.contains('modalPerf')) fecharModal('modalPerf');
  if (e.target.classList.contains('modalDetalhes')) fecharModal('modalDetalhes');
  if (e.target.classList.contains('modal')) fecharModal('modalPDFViewer');
};
</script>
</body>
</html>
