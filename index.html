<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OP BZERO - Análise de Operações</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    :root { --primary: #1e40af; --success: #059669; --gray: #f8fafc; --danger: #dc2626; --warning: #f59e0b; }
    body { font-family: 'Segoe UI', sans-serif; background:#f1f5f9; margin:0; padding:20px; color:#1e293b; }
    .container { max-width:1600px; margin:auto; background:white; border-radius:18px; box-shadow:0 10px 40px rgba(0,0,0,0.12); overflow:hidden; }
    header { background:linear-gradient(135deg,#1e3a8a,#3b82f6); color:white; padding:30px; text-align:center; }
    header h1 { margin:0; font-size:2.4rem; font-weight:700; }
    header p { margin-top:10px; opacity:0.95; }

    .upload-area { padding:80px 30px; text-align:center; border:3px dashed #94a3b8; border-radius:18px; background:var(--gray); margin:30px; cursor:pointer; transition:0.4s; }
    .upload-area:hover { border-color:var(--primary); background:#eff6ff; transform:translateY(-5px); }
    .upload-area i { font-size:70px; color:#64748b; margin-bottom:20px; }

    .controls { padding:25px 30px; background:var(--gray); border-bottom:1px solid #e2e8f0; }
    .filter-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; align-items:end; }
    .filter-group label { font-weight:600; margin-bottom:6px; display:block; }
    select { padding:12px 16px; border:1px solid #cbd5e1; border-radius:10px; background:white; font-size:15px; width:100%; }
    .buttons { display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; }
    button { padding:12px 22px; border:none; border-radius:10px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:8px; transition:0.3s; }
    .btn-primary { background:var(--primary); color:white; }
    .btn-primary:hover { background:#1e3a8a; }
    .btn-success { background:var(--success); color:white; }
    .btn-success:hover { background:#047857; }
    .btn-excel { background:#217346; color:white; }
    .btn-excel:hover { background:#185c37; }

    .dashboard { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:24px; padding:40px 30px; }
    .card { background:white; border-radius:16px; padding:25px; text-align:center; box-shadow:0 8px 25px rgba(0,0,0,0.1); transition:0.4s; }
    .card:hover { transform:translateY(-10px); }
    .card i { font-size:48px; margin-bottom:15px; color:#3b82f6; }
    .card h3 { margin:0 0 10px; color:var(--primary); }
    .card .value { font-size:2.8rem; font-weight:800; color:#1e3a8a; }

    .modal, .modalPerf { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); justify-content:center; align-items:center; z-index:1000; padding:20px; }
    .modal-content, .modalPerf-content { background:white; width:95%; max-width:1500px; max-height:95vh; border-radius:18px; overflow:hidden; box-shadow:0 25px 70px rgba(0,0,0,0.3); }
    .modal-header { background:var(--primary); color:white; padding:22px 35px; display:flex; justify-content:space-between; align-items:center; font-size:1.5rem; font-weight:600; }
    .modal-actions { display: flex; gap: 12px; align-items: center; }
    .close { font-size:38px; cursor:pointer; font-weight:bold; margin-left: 20px; }
    .modal-body { padding:35px; overflow-y:auto; max-height:calc(95vh - 120px); }

    .charts-container { display:grid; grid-template-columns:repeat(auto-fit,minmax(450px,1fr)); gap:30px; margin:30px 0; }
    .chart-card { background:white; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.08); }

    .depto-resumo { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; margin:40px 0; }
    .depto-card { background:#f8fafc; border-left:5px solid var(--primary); padding:20px; border-radius:8px; }
    .depto-card h4 { margin:0 0 15px; color:var(--primary); font-size:1.3rem; }
    .depto-card .stats { display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:14px; }
    .depto-card .stats strong { color:#1e3a8a; }

    .registros-depto { margin-top:50px; border-top:2px solid #e2e8f0; padding-top:30px; }
    .registros-depto h4 { color:var(--primary); margin-bottom:15px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; font-size:13px; }
    th { background:var(--primary); color:white; padding:12px; text-align:center; }
    td { padding:10px; text-align:center; border-bottom:1px solid #e2e8f0; }
    tr:hover { background:#f0f9ff; }

    .hidden { display:none !important; }
    .status { text-align:center; padding:15px; background:#d1fae5; color:#065f46; font-weight:600; border-radius:10px; margin:20px 30px; }
    .error-status { background:#fee2e2 !important; color:#991b1b !important; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>OP BZERO – Sistema de Inteligência Policial</h1>
    <p>Análise avançada de operações com foco em produtividade e resultados</p>
  </header>

  <div id="uploadSection" class="upload-area">
    <i class="fas fa-cloud-upload-alt"></i>
    <h3>Clique para importar o arquivo Excel</h3>
    <p><strong>OP BZERO.xlsx</strong></p>
    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none">
  </div>

  <div id="status" class="status hidden"></div>

  <div id="mainControls" class="hidden">
    <div class="controls">
      <div class="filter-row">
        <div class="filter-group">
          <label>Departamento</label>
          <select id="filterDepto"><option value="">Todos</option></select>
        </div>
        <div class="filter-group">
          <label>Unidade (DP)</label>
          <select id="filterUnid"><option value="">Todas</option></select>
        </div>
        <div class="filter-group">
          <label>Local / Comunidade</label>
          <select id="filterLocal"><option value="">Todos</option></select>
        </div>
        <div class="filter-group">
          <label>Facção</label>
          <select id="filterFaccao"><option value="">Todas</option></select>
        </div>
        <div class="buttons">
          <button id="btnAnalise" class="btn-primary"><i class="fas fa-chart-line"></i> Analisar Performance</button>
          <button id="btnPdf" class="btn-success"><i class="fas fa-file-pdf"></i> Gerar PDF Completo</button>
        </div>
      </div>
    </div>

    <div class="dashboard" id="dashboard"></div>
  </div>
</div>

<!-- Modal Performance -->
<div id="modalPerf" class="modalPerf">
  <div class="modalPerf-content">
    <div class="modal-header">
      <div>Análise de Performance por Departamento</div>
      <div class="modal-actions">
        <button id="btnExportarExcel" class="btn-excel" style="padding:8px 16px; font-size:14px;">
          <i class="fas fa-file-excel"></i> Exportar Excel
        </button>
        <span class="close">×</span>
      </div>
    </div>
    <div class="modal-body" id="modalPerfBody">
      <div class="charts-container">
        <div class="chart-card"><canvas id="chartPrisoes"></canvas></div>
        <div class="chart-card"><canvas id="chartArmas"></canvas></div>
      </div>
      <div class="charts-container">
        <div class="chart-card"><canvas id="chartOperacoes"></canvas></div>
        <div class="chart-card"><canvas id="chartPizza"></canvas></div>
      </div>

      <h3 style="margin:50px 0 20px; color:var(--primary); text-align:center;">Resumo por Departamento</h3>
      <div class="depto-resumo" id="deptoResumo"></div>

      <h3 style="margin:60px 0 20px; color:var(--primary); text-align:center;">Registros Detalhados por Departamento</h3>
      <div id="registrosDetalhados"></div>
    </div>
  </div>
</div>

<script>
// Conversor Excel → DD/MM/AAAA
function converterDataExcel(serial) {
  if (!serial) return "";
  const num = Number(serial);
  if (isNaN(num) || num < 1) return String(serial).trim();
  const dias = Math.floor(num - 25569);
  const data = new Date(dias * 86400000);
  const d = String(data.getUTCDate()).padStart(2,'0');
  const m = String(data.getUTCMonth()+1).padStart(2,'0');
  const a = data.getUTCFullYear();
  return `${d}/${m}/${a}`;
}

let dadosOriginais = [];
let charts = {};
let dadosFiltradosAtual = [];

// Upload
document.getElementById('uploadSection').onclick = () => document.getElementById('fileInput').click();

document.getElementById('fileInput').onchange = function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type:'array'});

      const sheetName = workbook.SheetNames.find(n => n.toUpperCase().includes('REGISTRO'));
      if (!sheetName) throw new Error("Aba 'REGISTROS' não encontrada!");

      const worksheet = workbook.Sheets[sheetName];
      const json = XLSX.utils.sheet_to_json(worksheet, {header:1, defval:""});

      const headers = json[0].map(h => String(h).trim());

      dadosOriginais = json.slice(1).map(row => {
        let obj = {};
        headers.forEach((h,i) => {
          const v = row[i];
          obj[h] = (h === 'DT EVENTO') ? converterDataExcel(v) : (v ?? "").toString().trim();
        });
        return obj;
      }).filter(r => r['REG OCOR'] || r['LOCAL'] || r['FACÇÃO']);

      dadosOriginais.sort((a,b) => {
        const da = a['DT EVENTO'] ? new Date(a['DT EVENTO'].split('/').reverse().join('-')) : new Date(0);
        const db = b['DT EVENTO'] ? new Date(b['DT EVENTO'].split('/').reverse().join('-')) : new Date(0);
        return db - da;
      });

      document.getElementById('status').textContent = `Sucesso! ${dadosOriginais.length} registros importados`;
      document.getElementById('status').classList.remove('hidden','error-status');
      document.getElementById('uploadSection').classList.add('hidden');
      document.getElementById('mainControls').classList.remove('hidden');

      popularFiltros();
      aplicarFiltros();

    } catch (err) {
      document.getElementById('status').textContent = `Erro: ${err.message}`;
      document.getElementById('status').classList.add('error-status');
      document.getElementById('status').classList.remove('hidden');
    }
  };
  reader.readAsArrayBuffer(file);
};

function popularFiltros() {
  const unique = c => [...new Set(dadosOriginais.map(r=>r[c]).filter(Boolean))].sort();
  const p = (id,v) => {
    const s = document.getElementById(id);
    s.innerHTML = '<option value="">Todos</option>';
    v.forEach(x=>s.add(new Option(x,x)));
  };
  p('filterDepto', unique('DEPTO'));
  p('filterUnid', unique('UNID (DP)'));
  p('filterLocal', unique('LOCAL'));
  p('filterFaccao', unique('FACÇÃO'));
  document.querySelectorAll('select').forEach(s=>s.onchange=aplicarFiltros);
}

function getDadosFiltrados() {
  let l = [...dadosOriginais];
  ['Depto','Unid','Local','Faccao'].forEach(t=>{
    const v = document.getElementById('filter'+t).value;
    if(v){
      const c = {Depto:'DEPTO',Unid:'UNID (DP)',Local:'LOCAL',Faccao:'FACÇÃO'}[t];
      l = l.filter(r=>r[c]===v);
    }
  });
  return l;
}

function aplicarFiltros() { 
  dadosFiltradosAtual = getDadosFiltrados();
  mostrarDashboard(dadosFiltradosAtual); 
}

function mostrarDashboard(reg) {
  const c = document.getElementById('dashboard');
  c.innerHTML = '';
  const cards = [
    {t:"Total de Registros",v:reg.length,i:"fa-clipboard-list"},
    {t:"Prisões Efetuadas",v:reg.reduce((a,r)=>a+(Number(r['PRISÕES'])||0),0),i:"fa-handcuffs"},
    {t:"Armas Apreendidas",v:reg.reduce((a,r)=>a+(Number(r['ARMAS'])||0),0),i:"fa-gun"},
    {t:"Locais Atuados",v:new Set(reg.map(r=>r['LOCAL']).filter(Boolean)).size,i:"fa-map-marker-alt"}
  ];
  cards.forEach(x=>{
    const d=document.createElement('div'); d.className='card';
    d.innerHTML=`<i class="fas ${x.i}"></i><h3>${x.t}</h3><div class="value">${x.v}</div>`;
    c.appendChild(d);
  });
}

// PERFORMANCE DETALHADA
document.getElementById('btnAnalise').onclick = () => {
  const dados = getDadosFiltrados();
  dadosFiltradosAtual = dados;

  // Agrupamento por DEPTO
  const porDepto = {};
  dados.forEach(r => {
    const d = r['DEPTO'] || 'Não Informado';
    if(!porDepto[d]) porDepto[d] = {ops:0,pris:0,arm:0,regs:[]};
    porDepto[d].ops++;
    porDepto[d].pris += Number(r['PRISÕES']||0);
    porDepto[d].arm += Number(r['ARMAS']||0);
    porDepto[d].regs.push(r);
  });

  const labels = Object.keys(porDepto);
  const ops = labels.map(k=>porDepto[k].ops);
  const pris = labels.map(k=>porDepto[k].pris);
  const armas = labels.map(k=>porDepto[k].arm);

  // Destruir gráficos anteriores
  Object.values(charts).forEach(ch => ch?.destroy());

  charts.prisoes = new Chart(document.getElementById('chartPrisoes'), {type:'bar', data:{labels, datasets:[{label:'Prisões',data:pris,backgroundColor:'#dc2626'}]}, options:{plugins:{title:{display:true,text:'Prisões por Departamento'}},scales:{y:{beginAtZero:true}}}});
  charts.armas = new Chart(document.getElementById('chartArmas'), {type:'bar', data:{labels, datasets:[{label:'Armas',data:armas,backgroundColor:'#f59e0b'}]}, options:{plugins:{title:{display:true,text:'Armas por Departamento'}},scales:{y:{beginAtZero:true}}}});
  charts.ops = new Chart(document.getElementById('chartOperacoes'), {type:'bar', data:{labels, datasets:[{label:'Operações',data:ops,backgroundColor:'#3b82f6'}]}, options:{plugins:{title:{display:true,text:'Operações por Departamento'}},scales:{y:{beginAtZero:true}}}});
  charts.pizza = new Chart(document.getElementById('chartPizza'), {type:'pie', data:{labels, datasets:[{data:ops,backgroundColor:['#3b82f6','#10b981','#f59e0b','#dc2626','#8b5cf6']}]}, options:{plugins:{title:{display:true,text:'Distribuição de Operações'}}}});

  // Cards de resumo por DEPTO
  const resumoDiv = document.getElementById('deptoResumo');
  resumoDiv.innerHTML = '';
  Object.entries(porDepto).sort((a,b)=>b[1].ops - a[1].ops).forEach(([depto, info]) => {
    const media = ((info.pris + info.arm) / info.ops).toFixed(2);
    const card = document.createElement('div');
    card.className = 'depto-card';
    card.innerHTML = `
      <h4>${depto}</h4>
      <div class="stats">
        <div><strong>${info.ops}</strong> operações</div>
        <div><strong>${info.pris}</strong> prisões</div>
        <div><strong>${info.arm}</strong> armas</div>
        <div><strong>${media}</strong> média/op</div>
      </div>
    `;
    resumoDiv.appendChild(card);
  });

  // Registros detalhados por DEPTO
  const detalhesDiv = document.getElementById('registrosDetalhados');
  detalhesDiv.innerHTML = '';
  Object.entries(porDepto).sort((a,b)=>b[1].ops - a[1].ops).forEach(([depto, info]) => {
    const div = document.createElement('div');
    div.className = 'registros-depto';
    div.innerHTML = `<h4>${depto} — ${info.ops} registros</h4>`;
    const table = document.createElement('table');
    table.innerHTML = `
      <thead><tr><th>RO</th><th>DATA</th><th>UNID</th><th>LOCAL</th><th>PRISÕES</th><th>ARMAS</th></tr></thead>
      <tbody>
        ${info.regs.map(r=>`
          <tr>
            <td>${r['REG OCOR']||''}</td>
            <td>${r['DT EVENTO']||''}</td>
            <td>${r['UNID (DP)']||''}</td>
            <td>${r['LOCAL']||''}</td>
            <td>${r['PRISÕES']||''}</td>
            <td>${r['ARMAS']||''}</td>
          </tr>
        `).join('')}
      </tbody>
    `;
    div.appendChild(table);
    detalhesDiv.appendChild(div);
  });

  document.getElementById('modalPerf').style.display='flex';
};

// ========== NOVA FUNCIONALIDADE: EXPORTAR PARA EXCEL ==========
document.getElementById('btnExportarExcel').onclick = () => {
  const dados = dadosFiltradosAtual;
  
  // Criar workbook
  const wb = XLSX.utils.book_new();
  
  // ABA 1: Resumo Geral
  const resumoData = [
    ['OP BZERO - RELATÓRIO DE ANÁLISE'],
    ['Gerado em:', new Date().toLocaleString('pt-BR')],
    [''],
    ['INDICADORES GERAIS'],
    ['Total de Registros', dados.length],
    ['Prisões Efetuadas', dados.reduce((a,r)=>a+(Number(r['PRISÕES'])||0),0)],
    ['Armas Apreendidas', dados.reduce((a,r)=>a+(Number(r['ARMAS'])||0),0)],
    ['Munições Apreendidas', dados.reduce((a,r)=>a+(Number(r['MUNIÇÕES'])||0),0)],
    ['Drogas Apreendidas (KG)', dados.reduce((a,r)=>a+(Number(r['DROGAS (KG)'])||0),0).toFixed(2)],
    ['Locais Atuados', new Set(dados.map(r=>r['LOCAL']).filter(Boolean)).size],
    ['Departamentos Envolvidos', new Set(dados.map(r=>r['DEPTO']).filter(Boolean)).size]
  ];
  const wsResumo = XLSX.utils.aoa_to_sheet(resumoData);
  XLSX.utils.book_append_sheet(wb, wsResumo, 'Resumo Geral');
  
  // ABA 2: Performance por Departamento
  const porDepto = {};
  dados.forEach(r => {
    const d = r['DEPTO'] || 'Não Informado';
    if(!porDepto[d]) porDepto[d] = {ops:0,pris:0,arm:0,mun:0,drog:0};
    porDepto[d].ops++;
    porDepto[d].pris += Number(r['PRISÕES']||0);
    porDepto[d].arm += Number(r['ARMAS']||0);
    porDepto[d].mun += Number(r['MUNIÇÕES']||0);
    porDepto[d].drog += Number(r['DROGAS (KG)']||0);
  });
  
  const perfData = [
    ['PERFORMANCE POR DEPARTAMENTO'],
    [''],
    ['Departamento', 'Operações', 'Prisões', 'Armas', 'Munições', 'Drogas (KG)', 'Média Result./Op']
  ];
  
  Object.entries(porDepto).sort((a,b)=>b[1].ops-a[1].ops).forEach(([dept, info]) => {
    const media = ((info.pris + info.arm) / info.ops).toFixed(2);
    perfData.push([dept, info.ops, info.pris, info.arm, info.mun, info.drog.toFixed(2), media]);
  });
  
  const wsPerf = XLSX.utils.aoa_to_sheet(perfData);
  XLSX.utils.book_append_sheet(wb, wsPerf, 'Performance Departamentos');
  
  // ABA 3: Dados Completos
  const headers = ['DEPTO', 'UNID (DP)', 'REG OCOR', 'DT EVENTO', 'LOCAL', 'FACÇÃO', 'PRISÕES', 'ARMAS', 'MUNIÇÕES', 'DROGAS (KG)', 'VEÍCULOS'];
  const dadosCompletos = [headers];
  
  dados.forEach(r => {
    dadosCompletos.push([
      r['DEPTO'] || '',
      r['UNID (DP)'] || '',
      r['REG OCOR'] || '',
      r['DT EVENTO'] || '',
      r['LOCAL'] || '',
      r['FACÇÃO'] || '',
      r['PRISÕES'] || '',
      r['ARMAS'] || '',
      r['MUNIÇÕES'] || '',
      r['DROGAS (KG)'] || '',
      r['VEÍCULOS'] || ''
    ]);
  });
  
  const wsDados = XLSX.utils.aoa_to_sheet(dadosCompletos);
  XLSX.utils.book_append_sheet(wb, wsDados, 'Dados Completos');
  
  // Salvar arquivo
  const nomeArquivo = `OP_BZERO_Analise_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.writeFile(wb, nomeArquivo);
  
  alert(`Planilha Excel exportada com sucesso!\nArquivo: ${nomeArquivo}`);
};

// Fechar modais
document.querySelectorAll('.close').forEach(c=>c.onclick=()=>c.closest('.modal,.modalPerf').style.display='none');
window.onclick = e => {
  if (e.target.classList.contains('modal') || e.target.classList.contains('modalPerf')) {
    e.target.style.display='none';
  }
};

// ========== PDF COMPLETO COM CARDS DE RESUMO ==========
document.getElementById('btnPdf').onclick = () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"landscape",unit:"mm",format:"a4"});
  const dados = getDadosFiltrados();

  // Cabeçalho
  doc.setFillColor(30, 64, 175);
  doc.rect(0, 0, 297, 40, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(24);
  doc.setFont(undefined, 'bold');
  doc.text("RELATÓRIO COMPLETO OP BZERO", 148, 18, {align:"center"});
  doc.setFontSize(11);
  doc.setFont(undefined, 'normal');
  doc.text(`Sistema de Inteligência Policial - Gerado em: ${new Date().toLocaleString('pt-BR')}`, 148, 28, {align:"center"});
  
  doc.setTextColor(0, 0, 0);
  
  // ========== CARDS DE RESUMO (NOVA FUNCIONALIDADE) ==========
  let y = 50;
  doc.setFontSize(16);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(30, 64, 175);
  doc.text("INDICADORES PRINCIPAIS", 148, y, {align:"center"});
  
  y += 10;
  
  const totalRegistros = dados.length;
  const totalPrisoes = dados.reduce((a,r)=>a+(Number(r['PRISÕES'])||0),0);
  const totalArmas = dados.reduce((a,r)=>a+(Number(r['ARMAS'])||0),0);
  const totalMunicoes = dados.reduce((a,r)=>a+(Number(r['MUNIÇÕES'])||0),0);
  const totalDrogas = dados.reduce((a,r)=>a+(Number(r['DROGAS (KG)'])||0),0).toFixed(2);
  const totalLocais = new Set(dados.map(r=>r['LOCAL']).filter(Boolean)).size;
  
  // Função para desenhar card
  const drawCard = (x, y, titulo, valor, cor) => {
    // Borda e fundo
    doc.setDrawColor(cor.r, cor.g, cor.b);
    doc.setLineWidth(0.5);
    doc.roundedRect(x, y, 60, 28, 3, 3, 'S');
    
    // Fundo colorido no topo
    doc.setFillColor(cor.r, cor.g, cor.b);
    doc.roundedRect(x, y, 60, 8, 3, 3, 'F');
    
    // Título
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(255, 255, 255);
    doc.text(titulo, x + 30, y + 5.5, {align:"center"});
    
    // Valor
    doc.setFontSize(22);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(30, 58, 138);
    doc.text(String(valor), x + 30, y + 20, {align:"center"});
  };
  
  // Desenhar cards em 3 linhas de 4 cards
  const cardWidth = 60;
  const cardSpacing = 8;
  const startX = 17;
  
  const cards = [
    {titulo: "Registros", valor: totalRegistros, cor: {r:59, g:130, b:246}},
    {titulo: "Prisões", valor: totalPrisoes, cor: {r:220, g:38, b:38}},
    {titulo: "Armas", valor: totalArmas, cor: {r:245, g:158, b:11}},
    {titulo: "Munições", valor: totalMunicoes, cor: {r:139, g:92, b:246}},
  ];
  
  cards.forEach((card, i) => {
    const col = i % 4;
    const x = startX + (col * (cardWidth + cardSpacing));
    drawCard(x, y, card.titulo, card.valor, card.cor);
  });
  
  y += 35;
  
  // Segunda linha de cards
  const cards2 = [
    {titulo: "Drogas (KG)", valor: totalDrogas, cor: {r:16, g:185, b:129}},
    {titulo: "Locais", valor: totalLocais, cor: {r:245, g:158, b:11}},
  ];
  
  cards2.forEach((card, i) => {
    const col = i;
    const x = startX + 68 + (col * (cardWidth + cardSpacing));
    drawCard(x, y, card.titulo, card.valor, card.cor);
  });
  
  y += 40;

  // Tabela resumo detalhada
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(30, 64, 175);
  doc.text("RESUMO DETALHADO", 148, y, {align:"center"});
  y += 5;
  
  doc.autoTable({
    head:[["Indicador","Total"]],
    body:[
      ["Total de Registros", totalRegistros],
      ["Prisões Efetuadas", totalPrisoes],
      ["Armas Apreendidas", totalArmas],
      ["Munições Apreendidas", totalMunicoes],
      ["Drogas Apreendidas (KG)", totalDrogas],
      ["Locais Atuados", totalLocais],
      ["Departamentos Envolvidos", new Set(dados.map(r=>r['DEPTO']).filter(Boolean)).size]
    ],
    startY: y,
    theme: 'grid',
    headStyles: {fillColor: [30, 64, 175], fontSize: 11, fontStyle: 'bold'},
    styles: {fontSize: 10, cellPadding: 3},
    columnStyles: {
      0: {fontStyle: 'bold', cellWidth: 80},
      1: {halign: 'center', cellWidth: 40}
    }
  });
  
  y = doc.lastAutoTable.finalY + 15;

  // Gráficos
  const addChart = (id, title) => {
    if (y > 160) {
      doc.addPage();
      y = 20;
    }
    const canvas = document.getElementById(id);
    if (!canvas) return;
    const img = canvas.toDataURL("image/png");
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(30, 64, 175);
    doc.text(title, 148, y, {align:"center"});
    y += 5;
    doc.addImage(img, 'PNG', 10, y, 277, 100);
    y += 110;
  };

  if (Object.keys(charts).length > 0) {
    doc.addPage();
    y = 20;
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(30, 64, 175);
    doc.text("ANÁLISE GRÁFICA POR DEPARTAMENTO", 148, y, {align:"center"});
    y += 15;
    
    addChart('chartPrisoes', 'Prisões por Departamento');
    addChart('chartArmas', 'Armas por Departamento');
    addChart('chartOperacoes', 'Operações por Departamento');
    addChart('chartPizza', 'Distribuição de Operações');
  }

  // Performance por departamento
  const porDepto = {};
  dados.forEach(r => {
    const d = r['DEPTO'] || 'Não Informado';
    if(!porDepto[d]) porDepto[d] = {ops:0,pris:0,arm:0,mun:0,drog:0};
    porDepto[d].ops++;
    porDepto[d].pris += Number(r['PRISÕES']||0);
    porDepto[d].arm += Number(r['ARMAS']||0);
    porDepto[d].mun += Number(r['MUNIÇÕES']||0);
    porDepto[d].drog += Number(r['DROGAS (KG)']||0);
  });
  
  doc.addPage();
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(30, 64, 175);
  doc.text("PERFORMANCE POR DEPARTAMENTO", 148, 20, {align:"center"});
  
  const perfBody = Object.entries(porDepto).sort((a,b)=>b[1].ops-a[1].ops).map(([d,info]) => {
    const media = ((info.pris + info.arm)/info.ops).toFixed(2);
    return [d, info.ops, info.pris, info.arm, info.mun, info.drog.toFixed(2), media];
  });
  
  doc.autoTable({
    head:[['Departamento', 'Operações', 'Prisões', 'Armas', 'Munições', 'Drogas (KG)', 'Média/Op']],
    body: perfBody,
    startY: 30,
    theme: 'striped',
    headStyles: {fillColor: [30, 64, 175], fontSize: 10, fontStyle: 'bold'},
    styles: {fontSize: 9, cellPadding: 2.5},
    columnStyles: {
      0: {cellWidth: 60},
      1: {halign: 'center', cellWidth: 25},
      2: {halign: 'center', cellWidth: 25},
      3: {halign: 'center', cellWidth: 25},
      4: {halign: 'center', cellWidth: 30},
      5: {halign: 'center', cellWidth: 30},
      6: {halign: 'center', cellWidth: 25}
    }
  });

  // Tabela completa de registros
  doc.addPage();
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.setTextColor(30, 64, 175);
  doc.text("REGISTROS DETALHADOS", 148, 20, {align:"center"});
  
  doc.autoTable({
    head:[['DEPTO','UNID','RO','DATA','LOCAL','FACÇÃO','PRISÕES','ARMAS','MUNIÇÕES','DROGAS']],
    body: dados.map(r=>[
      r['DEPTO']||'', r['UNID (DP)']||'', r['REG OCOR']||'', r['DT EVENTO']||'',
      r['LOCAL']||'', r['FACÇÃO']||'', r['PRISÕES']||'', r['ARMAS']||'', 
      r['MUNIÇÕES']||'', r['DROGAS (KG)']||''
    ]),
    startY: 30,
    theme: 'striped',
    headStyles: {fillColor: [30, 64, 175], fontSize: 9, fontStyle: 'bold'},
    styles: {fontSize: 8, cellPadding: 2},
    columnStyles: {
      0: {cellWidth: 25},
      1: {cellWidth: 20},
      2: {cellWidth: 25},
      3: {cellWidth: 23},
      4: {cellWidth: 45},
      5: {cellWidth: 25},
      6: {halign: 'center', cellWidth: 18},
      7: {halign: 'center', cellWidth: 18},
      8: {halign: 'center', cellWidth: 22},
      9: {halign: 'center', cellWidth: 20}
    }
  });

  // Rodapé em todas as páginas
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    doc.text(`Página ${i} de ${pageCount}`, 148, 205, {align: "center"});
    doc.text("OP BZERO - Sistema de Inteligência Policial", 148, 200, {align: "center"});
  }

  doc.save(`OP_BZERO_Completo_${new Date().toISOString().slice(0,10)}.pdf`);
};
</script>
</body>
</html>